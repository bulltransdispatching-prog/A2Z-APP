<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2Z IPM System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--p:#004080;--s:#002b55;--g:#28a745;--r:#dc3545}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Segoe UI',system-ui,sans-serif;background:#f0f2f5}
        .hide{display:none!important}
        
        .login-page{min-height:100vh;background:linear-gradient(135deg,var(--p),var(--s));display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:#fff;border-radius:16px;padding:40px 30px;width:100%;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
        .login-box h2{color:var(--p);text-align:center;margin-bottom:8px;font-weight:700}
        .login-box .subtitle{text-align:center;color:#666;margin-bottom:30px}
        .login-box .form-control{padding:12px 15px;border-radius:8px}
        .login-box .btn-primary{padding:12px;border-radius:8px;font-weight:600}
        
        .app-container{display:flex;min-height:100vh}
        .sidebar{width:260px;background:linear-gradient(180deg,var(--p),var(--s));color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:100;transition:transform .3s}
        .sidebar.closed{transform:translateX(-260px)}
        .sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
        .sidebar-header h4{margin:0;font-size:1.3rem}
        .nav-menu{padding:15px 0}
        .nav-link{display:flex;align-items:center;padding:12px 20px;color:rgba(255,255,255,.8);text-decoration:none;border-left:3px solid transparent;transition:all .2s}
        .nav-link:hover,.nav-link.active{background:rgba(255,255,255,.1);color:#fff;border-left-color:#ffc107}
        .nav-link i{width:24px;margin-right:12px}
        .nav-section{padding:15px 20px 8px;font-size:.7rem;text-transform:uppercase;opacity:.5}
        
        .main-content{flex:1;margin-left:260px;transition:margin .3s}
        .main-content.full{margin-left:0}
        .topbar{background:#fff;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.05);position:sticky;top:0;z-index:50}
        .menu-toggle{background:none;border:none;font-size:1.4rem;color:var(--p);cursor:pointer}
        .user-info{display:flex;align-items:center;gap:12px}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
        
        .page-content{padding:25px}
        .page-title{margin-bottom:20px;color:#333}
        
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:25px}
        .stat-card{background:#fff;border-radius:12px;padding:25px;display:flex;align-items:center;gap:20px;box-shadow:0 2px 15px rgba(0,0,0,.05)}
        .stat-icon{width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff}
        .stat-icon.blue{background:linear-gradient(135deg,#667eea,#764ba2)}
        .stat-icon.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
        .stat-icon.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
        .stat-icon.purple{background:linear-gradient(135deg,#4facfe,#00f2fe)}
        .stat-info h3{font-size:2rem;margin:0;color:#333}
        .stat-info p{margin:0;color:#888}
        
        .card{background:#fff;border:none;border-radius:12px;box-shadow:0 2px 15px rgba(0,0,0,.05);margin-bottom:20px}
        .card-header{background:var(--p);color:#fff;padding:15px 20px;border-radius:12px 12px 0 0!important;font-weight:600}
        .card-body{padding:20px}
        
        .table{margin:0}
        .table th{background:#f8f9fa;font-weight:600;border:none}
        .table td{vertical-align:middle;border-color:#f0f0f0}
        .badge-success{background:#d4edda;color:#155724}
        .badge-danger{background:#f8d7da;color:#721c24}
        
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}
        .form-card{background:#fff;border-radius:12px;padding:25px;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent}
        .form-card:hover{border-color:var(--p);transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.1)}
        .form-card i{font-size:2.5rem;color:var(--p);margin-bottom:12px}
        .form-card h6{margin:0;font-weight:600;color:#333}
        .form-card small{color:#888}
        
        .modal-header{border-radius:12px 12px 0 0}
        .modal-content{border:none;border-radius:12px}
        
        .toast-box{position:fixed;top:20px;right:20px;z-index:9999}
        .toast-item{background:#fff;border-radius:10px;padding:15px 20px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-bottom:10px;display:flex;align-items:center;gap:12px;animation:slideIn .3s}
        .toast-item.success{border-left:4px solid var(--g)}
        .toast-item.error{border-left:4px solid var(--r)}
        .toast-item.info{border-left:4px solid #17a2b8}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        .sync-badge{position:fixed;bottom:20px;right:20px;padding:10px 18px;border-radius:25px;font-size:.85rem;display:flex;align-items:center;gap:10px;z-index:9999;box-shadow:0 3px 15px rgba(0,0,0,.1)}
        .sync-badge.online{background:#d4edda;color:#155724}
        .sync-badge.offline{background:#f8d7da;color:#721c24}
        .sync-badge.syncing{background:#fff3cd;color:#856404}
        .sync-dot{width:10px;height:10px;border-radius:50%;animation:pulse 1.5s infinite}
        .online .sync-dot{background:#28a745}
        .offline .sync-dot{background:#dc3545}
        .syncing .sync-dot{background:#ffc107}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        
        .loc-box{padding:20px;border-radius:12px;display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .loc-box.ok{background:#d4edda;border:2px solid var(--g)}
        .loc-box.no{background:#f8d7da;border:2px solid var(--r)}
        .loc-box.wait{background:#cce5ff;border:2px solid #007bff}
        .loc-box i{font-size:1.8rem}
        #mapBox{height:250px;border-radius:12px;margin-bottom:15px}
        
        .report-container{background:#fff;max-width:800px;margin:0 auto}
        .report-header{background:var(--p);color:#fff;padding:25px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:15px}
        .report-header h3{margin:0;font-weight:700}
        .report-title{background:#f8f9fa;padding:15px 25px;border-bottom:3px solid var(--p)}
        .report-title h4{margin:0;color:var(--p)}
        .report-body{padding:25px}
        .info-box{display:grid;grid-template-columns:1fr 1fr;gap:12px;background:#f8f9fa;padding:18px;border-radius:10px;margin-bottom:20px;border-left:4px solid var(--p)}
        .info-box label{font-size:.75rem;text-transform:uppercase;color:#666;margin-bottom:2px}
        .info-box span{font-weight:600;color:#333}
        .summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px}
        .summary-card{background:#f8f9fa;padding:18px;text-align:center;border-radius:10px;border-left:3px solid var(--p)}
        .summary-card .value{font-size:1.8rem;font-weight:700;color:var(--p)}
        .summary-card .label{font-size:.75rem;color:#666}
        
        .remarks-section{background:#fff3cd;border:1px solid #ffc107;border-radius:10px;padding:15px;margin-top:20px}
        .remarks-section h6{color:#856404;margin-bottom:10px}
        
        @media(max-width:768px){
            .sidebar{transform:translateX(-260px)}
            .sidebar.open{transform:translateX(0)}
            .main-content{margin-left:0}
            .stats-grid{grid-template-columns:1fr 1fr}
            .info-box{grid-template-columns:1fr}
            .summary-cards{grid-template-columns:1fr 1fr}
        }
        
        @media print{
            .sidebar,.topbar,.no-print,.sync-badge{display:none!important}
            .main-content{margin:0!important}
            .page-content{padding:0!important}
        }
        
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
        .overlay.show{display:block}
        
        .loading-spinner{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px}
        .loading-spinner i{font-size:3rem;color:var(--p);margin-bottom:15px}
    </style>
</head>
<body>

<div class="toast-box" id="toastBox"></div>

<div class="sync-badge online" id="syncBadge">
    <div class="sync-dot"></div>
    <span id="syncText">Online</span>
</div>

<!-- ==================== LOGIN PAGE ==================== -->
<div id="loginPage" class="login-page">
    <div class="login-box">
        <h2><i class="fas fa-bug me-2"></i>A2Z IPM</h2>
        <p class="subtitle">Integrated Pest Management System</p>
        
        <div id="loginLoading" class="loading-spinner hide">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Connecting to server...</p>
        </div>
        
        <form id="loginForm">
            <div id="loginError" class="alert alert-danger hide"></div>
            <div class="mb-3">
                <label class="form-label fw-bold">Username</label>
                <input type="text" id="loginUser" class="form-control" required autocomplete="username">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Password</label>
                <div class="input-group">
                    <input type="password" id="loginPass" class="form-control" required autocomplete="current-password">
                    <button type="button" class="btn btn-outline-secondary" onclick="togglePassword()">
                        <i class="fas fa-eye" id="eyeIcon"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                <i class="fas fa-sign-in-alt me-2"></i>Login
            </button>
        </form>
    </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="mainApp" class="hide">
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-bug me-2"></i>A2Z IPM</h4>
        </div>
        <nav class="nav-menu">
            <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-home"></i>Dashboard</a>
            <a href="#" class="nav-link staff-only" data-page="dataentry"><i class="fas fa-edit"></i>Data Entry</a>
            <a href="#" class="nav-link" data-page="records"><i class="fas fa-file-alt"></i>Records</a>
            
            <div class="nav-section admin-only">Administration</div>
            <a href="#" class="nav-link admin-only" data-page="staff"><i class="fas fa-users"></i>Staff</a>
            <a href="#" class="nav-link admin-only" data-page="clients"><i class="fas fa-user-tie"></i>Clients</a>
            <a href="#" class="nav-link admin-only" data-page="projects"><i class="fas fa-building"></i>Projects</a>
            <a href="#" class="nav-link admin-only" data-page="remarks"><i class="fas fa-comments"></i>Client Remarks</a>
            
            <div class="nav-section">Account</div>
            <a href="#" class="nav-link" data-page="settings"><i class="fas fa-cog"></i>Settings</a>
            <a href="#" class="nav-link" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i>Logout</a>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <header class="topbar no-print">
            <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <div class="user-info">
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold" id="headerUserName">Admin</div>
                    <small class="text-muted" id="headerUserRole">Administrator</small>
                </div>
                <div class="user-avatar" id="headerUserAvatar">A</div>
            </div>
        </header>
        
        <div class="page-content">
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page-section">
                <h4 class="page-title"><i class="fas fa-home me-2"></i>Dashboard</h4>
                <div class="stats-grid" id="dashStats"></div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-clock me-2"></i>Recent Activity</div>
                    <div class="card-body" id="dashActivity">
                        <p class="text-muted mb-0">No recent activity</p>
                    </div>
                </div>
            </div>
            
            <!-- Data Entry Page -->
            <div id="page-dataentry" class="page-section hide">
                <h4 class="page-title"><i class="fas fa-edit me-2"></i>Data Entry</h4>
                <div class="card mb-4">
                    <div class="card-body">
                        <label class="form-label fw-bold">Select Project</label>
                        <select id="projectSelect" class="form-select form-select-lg"></select>
                    </div>
                </div>
                <div class="form-grid" id="formCards"></div>
            </div>
            
            <!-- Records Page -->
            <div id="page-records" class="page-section hide">
                <h4 class="page-title"><i class="fas fa-file-alt me-2"></i>Records</h4>
                <div class="card mb-3 no-print">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="date" id="filterFrom" class="form-control" placeholder="From"></div>
                            <div class="col-md-3"><input type="date" id="filterTo" class="form-control" placeholder="To"></div>
                            <div class="col-md-3"><select id="filterType" class="form-select"><option value="">All Types</option></select></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="loadRecordsPage()"><i class="fas fa-filter me-1"></i>Filter</button></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Date</th><th>Project</th><th>Type</th><th>By</th><th>Actions</th></tr></thead>
                                <tbody id="recordsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Page -->
            <div id="page-staff" class="page-section hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="page-title mb-0"><i class="fas fa-users me-2"></i>Staff Management</h4>
                    <button class="btn btn-primary" onclick="openStaffModal()"><i class="fas fa-plus me-1"></i>Add Staff</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Emp ID</th><th>Name</th><th>Username</th><th>Projects</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="staffTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Clients Page -->
            <div id="page-clients" class="page-section hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="page-title mb-0"><i class="fas fa-user-tie me-2"></i>Client Accounts</h4>
                    <button class="btn btn-primary" onclick="openClientModal()"><i class="fas fa-plus me-1"></i>Add Client</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Username</th><th>Client Name</th><th>Project</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="clientsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Projects Page -->
            <div id="page-projects" class="page-section hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="page-title mb-0"><i class="fas fa-building me-2"></i>Projects</h4>
                    <button class="btn btn-primary" onclick="openProjectModal()"><i class="fas fa-plus me-1"></i>Add Project</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Code</th><th>Name</th><th>Client</th><th>GPS</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="projectsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Client Remarks Page (Admin Only) -->
            <div id="page-remarks" class="page-section hide">
                <h4 class="page-title"><i class="fas fa-comments me-2"></i>Client Remarks</h4>
                <div class="card">
                    <div class="card-body" id="remarksContent">
                        <p class="text-muted">No remarks yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="page-settings" class="page-section hide">
                <h4 class="page-title"><i class="fas fa-cog me-2"></i>Settings</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-user me-2"></i>My Profile</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" id="settingsName" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="settingsPass" class="form-control" placeholder="Leave empty to keep current">
                                </div>
                                <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save me-1"></i>Save Changes</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 admin-only">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-database me-2"></i>Data Management</div>
                            <div class="card-body">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="exportAllData()"><i class="fas fa-download me-1"></i>Export All Data</button>
                                <button class="btn btn-outline-danger w-100" onclick="clearAllData()"><i class="fas fa-trash me-1"></i>Clear All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Staff Modal -->
<div class="modal fade" id="staffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="staffKey">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Employee ID *</label>
                        <input type="text" id="staffEmpId" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="staffName" class="form-control" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Username *</label>
                        <input type="text" id="staffUsername" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Password *</label>
                        <input type="text" id="staffPassword" class="form-control">
                        <small class="text-muted" id="staffPassHint">Required for new staff</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input type="text" id="staffPhone" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Projects</label>
                    <div id="staffProjectsList" class="border rounded p-2" style="max-height:150px;overflow-y:auto"></div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="staffActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()"><i class="fas fa-save me-1"></i>Save Staff</button>
            </div>
        </div>
    </div>
</div>

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="clientModalTitle">Add Client</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="clientKey">
                <div class="mb-3">
                    <label class="form-label">Client/Company Name *</label>
                    <input type="text" id="clientName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Username *</label>
                    <input type="text" id="clientUsername" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password *</label>
                    <input type="text" id="clientPassword" class="form-control">
                    <small class="text-muted" id="clientPassHint">Required for new client</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Project *</label>
                    <select id="clientProject" class="form-select" required></select>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="clientActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveClient()"><i class="fas fa-save me-1"></i>Save Client</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="projectModalTitle">Add Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="projectKey">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Code *</label>
                        <input type="text" id="projectCode" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Name *</label>
                        <input type="text" id="projectName" class="form-control" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client Name *</label>
                        <input type="text" id="projectClient" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" id="projectContact" class="form-control">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <input type="text" id="projectAddress" class="form-control">
                </div>
                <div class="card bg-light mb-3">
                    <div class="card-header py-2">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="projectGpsEnabled">
                            <label class="form-check-label"><i class="fas fa-map-marker-alt me-1"></i>Enable GPS Authentication</label>
                        </div>
                    </div>
                    <div class="card-body py-3">
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label small">Latitude</label>
                                <input type="number" step="any" id="projectLat" class="form-control form-control-sm">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Longitude</label>
                                <input type="number" step="any" id="projectLng" class="form-control form-control-sm">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Radius (m)</label>
                                <input type="number" id="projectRadius" class="form-control form-control-sm" value="50">
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="captureLocation()">
                            <i class="fas fa-crosshairs me-1"></i>Use My Location
                        </button>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="projectActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProject()"><i class="fas fa-save me-1"></i>Save Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Form Entry Modal -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="formModalTitle">Form</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="formModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveFormData()"><i class="fas fa-save me-1"></i>Save Record</button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Attendance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="gpsCheckSection">
                    <div id="locationStatus" class="loc-box wait">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <div><strong>Checking your location...</strong><br><small>Please allow location access</small></div>
                    </div>
                    <div id="mapBox"></div>
                </div>
                <div id="attendanceForm" class="hide">
                    <div class="alert alert-info py-2" id="gpsSkippedMsg" style="display:none">
                        <i class="fas fa-info-circle me-1"></i>GPS authentication is disabled for this project
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" id="attDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time In</label>
                            <input type="time" id="attTimeIn" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time Out</label>
                            <input type="time" id="attTimeOut" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Work Done</label>
                        <textarea id="attWork" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea id="attRemarks" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <input type="hidden" id="attLat">
                <input type="hidden" id="attLng">
                <input type="hidden" id="attDist">
                <input type="hidden" id="attVerified">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary hide" id="retryLocationBtn" onclick="checkUserLocation()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveAttendanceBtn" onclick="saveAttendance()" disabled>
                    <i class="fas fa-save me-1"></i>Save Attendance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Record Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">View Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="viewModalBody"></div>
            <div class="modal-footer no-print">
                <button class="btn btn-outline-primary" onclick="window.print()"><i class="fas fa-print me-1"></i>Print</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Client Remark Modal -->
<div class="modal fade" id="remarkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-comment me-2"></i>Add Remark</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Your Remark</label>
                    <textarea id="remarkText" class="form-control" rows="4" placeholder="Enter your feedback or remarks..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="saveRemark()"><i class="fas fa-paper-plane me-1"></i>Submit</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ==================== CONFIGURATION ====================
const CONFIG = {
    company: {
        name: 'A2Z Industrial Solutions',
        address: '30-F, J-1 Market, Wapda Town, Lahore',
        phone: '0307-0430056',
        email: 'info@a2zidsolutions.com'
    },
    firebase: {
        apiKey: "AIzaSyCMBoABKBWTOx1B6zEBCk7QCeTKogUYgxQ",
        authDomain: "a2z-ipm.firebaseapp.com",
        databaseURL: "https://a2z-ipm-default-rtdb.firebaseio.com",
        projectId: "a2z-ipm",
        storageBucket: "a2z-ipm.firebasestorage.app",
        messagingSenderId: "37433212653",
        appId: "1:37433212653:web:e58af93855931236d456e4"
    }
};

// Initialize Firebase
firebase.initializeApp(CONFIG.firebase);
const DB = firebase.database();

// ==================== GLOBAL STATE ====================
let currentUser = null;
let currentPage = 'dashboard';
let currentProject = null;
let currentFormType = null;
let leafletMap = null;
let isOnline = navigator.onLine;

// Data caches (updated in real-time)
let USERS = [];
let PROJECTS = [];
let RECORDS = [];
let REMARKS = [];

// ==================== UTILITY FUNCTIONS ====================
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast-item ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'times-circle text-danger' : 'info-circle text-info'}"></i><span>${message}</span>`;
    $('toastBox').appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

function updateSyncStatus(status) {
    $('syncBadge').className = 'sync-badge ' + status;
    $('syncText').textContent = status === 'online' ? 'Online' : status === 'offline' ? 'Offline' : 'Syncing...';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('en-GB');
}

function formatDateTime(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp).toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function getFormTypeName(type) {
    const names = {
        attendance: 'Attendance',
        insecticide: 'Insecticide Log',
        gluebox: 'Glue Box Monitoring',
        efk: 'EFK Monitoring',
        lizard: 'Lizard Trapping',
        cat: 'Cat Trapping',
        snake: 'Snake Box',
        checklist: 'IPM Checklist'
    };
    return names[type] || type;
}

// Network status
window.addEventListener('online', () => { isOnline = true; updateSyncStatus('online'); });
window.addEventListener('offline', () => { isOnline = false; updateSyncStatus('offline'); });

// ==================== FIREBASE REALTIME LISTENERS ====================
function setupRealtimeListeners() {
    console.log('Setting up realtime listeners...');
    
    // Users listener
    DB.ref('users').on('value', snapshot => {
        USERS = [];
        snapshot.forEach(child => {
            USERS.push({ key: child.key, ...child.val() });
        });
        console.log('Users updated:', USERS.length);
        if (currentUser) refreshCurrentPage();
    }, error => {
        console.error('Users listener error:', error);
    });
    
    // Projects listener
    DB.ref('projects').on('value', snapshot => {
        PROJECTS = [];
        snapshot.forEach(child => {
            PROJECTS.push({ key: child.key, ...child.val() });
        });
        console.log('Projects updated:', PROJECTS.length);
        if (currentUser) refreshCurrentPage();
    }, error => {
        console.error('Projects listener error:', error);
    });
    
    // Records listener
    DB.ref('records').on('value', snapshot => {
        RECORDS = [];
        snapshot.forEach(child => {
            RECORDS.push({ key: child.key, ...child.val() });
        });
        console.log('Records updated:', RECORDS.length);
        if (currentUser) refreshCurrentPage();
    }, error => {
        console.error('Records listener error:', error);
    });
    
    // Remarks listener
    DB.ref('remarks').on('value', snapshot => {
        REMARKS = [];
        snapshot.forEach(child => {
            REMARKS.push({ key: child.key, ...child.val() });
        });
        console.log('Remarks updated:', REMARKS.length);
        if (currentUser && currentPage === 'remarks') loadRemarksPage();
    }, error => {
        console.error('Remarks listener error:', error);
    });
}

// ==================== INITIALIZATION ====================
async function initApp() {
    console.log('Initializing app...');
    updateSyncStatus(isOnline ? 'online' : 'offline');
    
    $('loginLoading').classList.remove('hide');
    $('loginForm').classList.add('hide');
    
    try {
        // Setup realtime listeners
        setupRealtimeListeners();
        
        // Wait for initial data load
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Ensure admin exists
        await ensureAdminExists();
        
        // Check for saved session
        const savedUser = localStorage.getItem('a2z_current_user');
        if (savedUser) {
            const userData = JSON.parse(savedUser);
            const user = USERS.find(u => u.key === userData.key && u.active);
            if (user) {
                currentUser = user;
                showMainApp();
                $('loginLoading').classList.add('hide');
                return;
            }
        }
        
        // Show login form
        $('loginLoading').classList.add('hide');
        $('loginForm').classList.remove('hide');
        
    } catch (error) {
        console.error('Init error:', error);
        $('loginLoading').classList.add('hide');
        $('loginForm').classList.remove('hide');
        showToast('Connection error. Please refresh.', 'error');
    }
}

async function ensureAdminExists() {
    const adminExists = USERS.find(u => u.username === 'admin' && u.role === 'admin');
    
    if (!adminExists) {
        console.log('Creating default admin...');
        await DB.ref('users').push({
            empId: 'ADM001',
            name: 'Administrator',
            username: 'admin',
            password: 'admin123',
            role: 'admin',
            projects: [],
            active: true,
            createdAt: Date.now()
        });
        console.log('Admin created successfully');
        
        // Wait for listener to update
        await new Promise(resolve => setTimeout(resolve, 500));
    }
}

// ==================== AUTHENTICATION ====================
$('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = $('loginUser').value.trim().toLowerCase();
    const password = $('loginPass').value;
    
    $('loginBtn').disabled = true;
    $('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Logging in...';
    $('loginError').classList.add('hide');
    
    try {
        // Find user
        const user = USERS.find(u => 
            u.username && 
            u.username.toLowerCase() === username && 
            u.password === password && 
            u.active === true
        );
        
        if (user) {
            currentUser = user;
            localStorage.setItem('a2z_current_user', JSON.stringify({ key: user.key, username: user.username }));
            showMainApp();
            showToast('Welcome, ' + user.name + '!');
        } else {
            $('loginError').textContent = 'Invalid username or password';
            $('loginError').classList.remove('hide');
        }
    } catch (error) {
        console.error('Login error:', error);
        $('loginError').textContent = 'Login failed. Please try again.';
        $('loginError').classList.remove('hide');
    }
    
    $('loginBtn').disabled = false;
    $('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Login';
});

function togglePassword() {
    const passInput = $('loginPass');
    const eyeIcon = $('eyeIcon');
    if (passInput.type === 'password') {
        passInput.type = 'text';
        eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        passInput.type = 'password';
        eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

function doLogout() {
    currentUser = null;
    localStorage.removeItem('a2z_current_user');
    location.reload();
}

// ==================== MAIN APP ====================
function showMainApp() {
    $('loginPage').classList.add('hide');
    $('mainApp').classList.remove('hide');
    
    // Update header
    $('headerUserName').textContent = currentUser.name;
    $('headerUserRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role === 'staff' ? 'Staff' : 'Client';
    $('headerUserAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
    
    // Show/hide menu items based on role
    const isAdmin = currentUser.role === 'admin';
    const isClient = currentUser.role === 'client';
    
    $$('.admin-only').forEach(el => el.classList.toggle('hide', !isAdmin));
    $$('.staff-only').forEach(el => el.classList.toggle('hide', isClient));
    
    // Load dashboard
    navigateTo('dashboard');
}

function toggleSidebar() {
    const sidebar = $('sidebar');
    const overlay = $('overlay');
    const mainContent = $('mainContent');
    
    if (window.innerWidth < 769) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
    } else {
        sidebar.classList.toggle('closed');
        mainContent.classList.toggle('full');
    }
}

// Navigation
$$('.nav-link[data-page]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = this.dataset.page;
        navigateTo(page);
        
        if (window.innerWidth < 769) {
            toggleSidebar();
        }
    });
});

function navigateTo(page) {
    currentPage = page;
    
    // Update active nav
    $$('.nav-link').forEach(link => link.classList.remove('active'));
    const activeLink = document.querySelector(`.nav-link[data-page="${page}"]`);
    if (activeLink) activeLink.classList.add('active');
    
    // Hide all pages
    $$('.page-section').forEach(section => section.classList.add('hide'));
    
    // Show target page
    const targetPage = $(`page-${page}`);
    if (targetPage) targetPage.classList.remove('hide');
    
    // Load page content
    refreshCurrentPage();
}

function refreshCurrentPage() {
    switch (currentPage) {
        case 'dashboard': loadDashboard(); break;
        case 'dataentry': loadDataEntryPage(); break;
        case 'records': loadRecordsPage(); break;
        case 'staff': loadStaffPage(); break;
        case 'clients': loadClientsPage(); break;
        case 'projects': loadProjectsPage(); break;
        case 'remarks': loadRemarksPage(); break;
        case 'settings': loadSettingsPage(); break;
    }
}

// ==================== DASHBOARD ====================
function loadDashboard() {
    const today = new Date().toISOString().split('T')[0];
    
    let myRecords = RECORDS;
    let myProjects = PROJECTS;
    
    // Filter based on role
    if (currentUser.role === 'staff') {
        const assignedProjects = currentUser.projects || [];
        myProjects = PROJECTS.filter(p => assignedProjects.includes(p.key));
        myRecords = RECORDS.filter(r => r.userKey === currentUser.key);
    } else if (currentUser.role === 'client') {
        myProjects = PROJECTS.filter(p => p.key === currentUser.projectKey);
        myRecords = RECORDS.filter(r => r.projectKey === currentUser.projectKey);
    }
    
    // Stats
    let statsHTML = '';
    if (currentUser.role === 'admin') {
        statsHTML = `
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fas fa-building"></i></div>
                <div class="stat-info"><h3>${PROJECTS.filter(p => p.active).length}</h3><p>Active Projects</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fas fa-users"></i></div>
                <div class="stat-info"><h3>${USERS.filter(u => u.role === 'staff' && u.active).length}</h3><p>Active Staff</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange"><i class="fas fa-clipboard-check"></i></div>
                <div class="stat-info"><h3>${RECORDS.filter(r => r.date === today).length}</h3><p>Today's Entries</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fas fa-file-alt"></i></div>
                <div class="stat-info"><h3>${RECORDS.length}</h3><p>Total Records</p></div>
            </div>
        `;
    } else {
        statsHTML = `
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fas fa-building"></i></div>
                <div class="stat-info"><h3>${myProjects.length}</h3><p>My Projects</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange"><i class="fas fa-clipboard-check"></i></div>
                <div class="stat-info"><h3>${myRecords.filter(r => r.date === today).length}</h3><p>Today's Entries</p></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fas fa-file-alt"></i></div>
                <div class="stat-info"><h3>${myRecords.length}</h3><p>Total Records</p></div>
            </div>
        `;
    }
    $('dashStats').innerHTML = statsHTML;
    
    // Recent activity
    const recentRecords = myRecords.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 8);
    
    if (recentRecords.length > 0) {
        $('dashActivity').innerHTML = recentRecords.map(record => {
            const project = PROJECTS.find(p => p.key === record.projectKey);
            const user = USERS.find(u => u.key === record.userKey);
            return `
                <div class="d-flex align-items-center gap-3 py-2 border-bottom">
                    <div class="stat-icon blue" style="width:40px;height:40px;font-size:1rem"><i class="fas fa-clipboard-check"></i></div>
                    <div class="flex-grow-1">
                        <strong>${getFormTypeName(record.formType)}</strong>
                        <br><small class="text-muted">${project?.name || '-'}  ${user?.name || '-'}</small>
                    </div>
                    <small class="text-muted">${formatDateTime(record.createdAt)}</small>
                </div>
            `;
        }).join('');
    } else {
        $('dashActivity').innerHTML = '<p class="text-muted mb-0">No recent activity</p>';
    }
    
    // Add remark button for clients
    if (currentUser.role === 'client') {
        $('dashActivity').innerHTML += `
            <div class="mt-3 pt-3 border-top">
                <button class="btn btn-warning" onclick="openRemarkModal()">
                    <i class="fas fa-comment me-1"></i>Add Remark / Feedback
                </button>
            </div>
        `;
    }
}

// ==================== DATA ENTRY PAGE ====================
function loadDataEntryPage() {
    // Load project dropdown
    let projectsList = PROJECTS.filter(p => p.active);
    
    if (currentUser.role === 'staff') {
        const assignedProjects = currentUser.projects || [];
        projectsList = projectsList.filter(p => assignedProjects.includes(p.key));
    }
    
    $('projectSelect').innerHTML = '<option value="">-- Select Project --</option>' + 
        projectsList.map(p => `<option value="${p.key}">${p.code} - ${p.name}</option>`).join('');
    
    // Form cards
    const forms = [
        { type: 'attendance', icon: 'clipboard-user', name: 'Attendance', gps: true },
        { type: 'insecticide', icon: 'spray-can', name: 'Insecticide Log' },
        { type: 'gluebox', icon: 'box-open', name: 'Glue Box' },
        { type: 'efk', icon: 'lightbulb', name: 'EFK Monitoring' },
        { type: 'lizard', icon: 'dragon', name: 'Lizard Trapping' },
        { type: 'cat', icon: 'cat', name: 'Cat Trapping' },
        { type: 'snake', icon: 'worm', name: 'Snake Box' },
        { type: 'checklist', icon: 'tasks', name: 'IPM Checklist' }
    ];
    
    $('formCards').innerHTML = forms.map(form => `
        <div class="form-card" onclick="openFormEntry('${form.type}')">
            <i class="fas fa-${form.icon}"></i>
            <h6>${form.name}</h6>
            ${form.gps ? '<small class="text-success"><i class="fas fa-map-marker-alt me-1"></i>GPS Enabled</small>' : '<small class="text-muted">Manual Entry</small>'}
        </div>
    `).join('');
}

function openFormEntry(formType) {
    const projectKey = $('projectSelect').value;
    if (!projectKey) {
        showToast('Please select a project first', 'error');
        return;
    }
    
    currentProject = PROJECTS.find(p => p.key === projectKey);
    currentFormType = formType;
    
    if (formType === 'attendance') {
        openAttendanceModal();
    } else {
        openFormModal(formType);
    }
}

// ==================== FORM MODAL ====================
function openFormModal(formType) {
    $('formModalTitle').textContent = getFormTypeName(formType);
    $('formModalBody').innerHTML = generateFormHTML(formType);
    new bootstrap.Modal($('formModal')).show();
}

function generateFormHTML(formType) {
    const today = new Date().toISOString().split('T')[0];
    const now = new Date().toTimeString().slice(0, 5);
    
    const baseFields = `
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label">Date *</label>
                <input type="date" id="formDate" class="form-control" value="${today}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Time</label>
                <input type="time" id="formTime" class="form-control" value="${now}">
            </div>
        </div>
    `;
    
    let specificFields = '';
    
    if (formType === 'insecticide') {
        specificFields = `
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Chemical</label>
                    <select id="formChemical" class="form-select">
                        <option>Deltamethrin</option>
                        <option>Alphacypermethrin</option>
                        <option>Cypermethrin</option>
                        <option>Bifenthrin</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity (ml)</label>
                    <input type="number" id="formQty" class="form-control" value="50">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Water (L)</label>
                    <input type="number" id="formWater" class="form-control" value="10">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Areas Treated</label>
                <div id="areasList" class="mb-2">
                    ${['Outside', 'Drain', 'Washroom', 'Office', 'Storage'].map(area => 
                        `<span class="badge bg-primary me-2 mb-2 area-tag" style="cursor:pointer" onclick="this.remove()">${area} <i class="fas fa-times ms-1"></i></span>`
                    ).join('')}
                </div>
                <div class="input-group">
                    <input type="text" id="newArea" class="form-control" placeholder="Add new area">
                    <button class="btn btn-outline-primary" type="button" onclick="addAreaTag()">Add</button>
                </div>
            </div>
        `;
    } else if (formType === 'checklist') {
        const checkItems = ['Spray Treatment', 'EFK Inspection', 'Glue Box Check', 'Bait Station Check', 'Chemical Inventory', 'Snake Box Check', 'Documentation'];
        specificFields = `
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Time In</label>
                    <input type="time" id="formTimeIn" class="form-control" value="${now}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Time Out</label>
                    <input type="time" id="formTimeOut" class="form-control">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Activities</label>
                <table class="table table-sm">
                    <tbody>
                        ${checkItems.map((item, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${item}</td>
                                <td>
                                    <select class="form-select form-select-sm checklist-item" data-item="${item}">
                                        <option value="done">Done</option>
                                        <option value="pending">Pending</option>
                                        <option value="na">N/A</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        // Generic form with entries
        specificFields = `
            <div class="mb-3">
                <label class="form-label">Entries</label>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr><th>#</th><th>Location</th><th>Count</th><th>Status</th><th></th></tr>
                    </thead>
                    <tbody id="entriesBody"></tbody>
                </table>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEntryRow()">
                    <i class="fas fa-plus me-1"></i>Add Row
                </button>
            </div>
        `;
    }
    
    return baseFields + specificFields + `
        <div class="mb-3">
            <label class="form-label">Remarks</label>
            <textarea id="formRemarks" class="form-control" rows="2"></textarea>
        </div>
    `;
}

let entryRowCount = 0;

function addEntryRow() {
    entryRowCount++;
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${entryRowCount}</td>
        <td><input type="text" class="form-control form-control-sm entry-loc" placeholder="Location"></td>
        <td><input type="number" class="form-control form-control-sm entry-count" value="0" min="0"></td>
        <td>
            <select class="form-select form-select-sm entry-status">
                <option value="ok">OK</option>
                <option value="damaged">Damaged</option>
                <option value="replaced">Replaced</option>
            </select>
        </td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
    `;
    $('entriesBody').appendChild(row);
}

function addAreaTag() {
    const input = $('newArea');
    const value = input.value.trim();
    if (value) {
        const tag = document.createElement('span');
        tag.className = 'badge bg-primary me-2 mb-2 area-tag';
        tag.style.cursor = 'pointer';
        tag.innerHTML = `${value} <i class="fas fa-times ms-1"></i>`;
        tag.onclick = () => tag.remove();
        $('areasList').appendChild(tag);
        input.value = '';
    }
}

function saveFormData() {
    const date = $('formDate')?.value;
    if (!date) {
        showToast('Please enter a date', 'error');
        return;
    }
    
    const recordData = {
        formType: currentFormType,
        projectKey: currentProject.key,
        userKey: currentUser.key,
        date: date,
        time: $('formTime')?.value || '',
        remarks: $('formRemarks')?.value || '',
        createdAt: Date.now()
    };
    
    // Add form-specific data
    if (currentFormType === 'insecticide') {
        recordData.chemical = $('formChemical').value;
        recordData.qty = $('formQty').value;
        recordData.water = $('formWater').value;
        recordData.areas = [...$$('.area-tag')].map(tag => tag.textContent.replace(' ', '').trim());
    } else if (currentFormType === 'checklist') {
        recordData.timeIn = $('formTimeIn')?.value || '';
        recordData.timeOut = $('formTimeOut')?.value || '';
        recordData.activities = [...$$('.checklist-item')].map(sel => ({
            item: sel.dataset.item,
            status: sel.value
        }));
    } else {
        recordData.entries = [...$$('#entriesBody tr')].map((row, i) => ({
            sr: i + 1,
            location: row.querySelector('.entry-loc')?.value || '',
            count: parseInt(row.querySelector('.entry-count')?.value) || 0,
            status: row.querySelector('.entry-status')?.value || 'ok'
        }));
    }
    
    // Save to Firebase
    DB.ref('records').push(recordData)
        .then(() => {
            bootstrap.Modal.getInstance($('formModal')).hide();
            showToast('Record saved successfully!');
            entryRowCount = 0;
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save record', 'error');
        });
}

// ==================== ATTENDANCE MODAL ====================
function openAttendanceModal() {
    const today = new Date().toISOString().split('T')[0];
    const now = new Date().toTimeString().slice(0, 5);
    
    $('attDate').value = today;
    $('attTimeIn').value = now;
    $('attTimeOut').value = '';
    $('attWork').value = '';
    $('attRemarks').value = '';
    $('attVerified').value = 'false';
    $('attLat').value = '';
    $('attLng').value = '';
    $('attDist').value = '';
    
    new bootstrap.Modal($('attendanceModal')).show();
    
    // Check if GPS is enabled for this project
    if (currentProject.gpsEnabled && currentProject.lat && currentProject.lng) {
        $('gpsCheckSection').classList.remove('hide');
        $('gpsSkippedMsg').style.display = 'none';
        $('attendanceForm').classList.add('hide');
        $('saveAttendanceBtn').disabled = true;
        $('retryLocationBtn').classList.add('hide');
        
        // Initialize map
        setTimeout(() => {
            if (leafletMap) leafletMap.remove();
            leafletMap = L.map('mapBox').setView([currentProject.lat, currentProject.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);
            L.marker([currentProject.lat, currentProject.lng]).addTo(leafletMap).bindPopup(currentProject.name);
            L.circle([currentProject.lat, currentProject.lng], { 
                radius: currentProject.radius || 50, 
                color: '#004080', 
                fillOpacity: 0.1 
            }).addTo(leafletMap);
            
            checkUserLocation();
        }, 500);
    } else {
        // GPS not enabled
        $('gpsCheckSection').classList.add('hide');
        $('gpsSkippedMsg').style.display = 'block';
        $('attendanceForm').classList.remove('hide');
        $('saveAttendanceBtn').disabled = false;
        $('attVerified').value = 'skipped';
    }
}

function checkUserLocation() {
    $('retryLocationBtn').classList.add('hide');
    $('locationStatus').className = 'loc-box wait';
    $('locationStatus').innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i><div><strong>Getting your location...</strong><br><small>Please wait...</small></div>';
    
    if (!navigator.geolocation) {
        showLocationError('Geolocation is not supported by your browser');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        position => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const distance = calculateDistance(userLat, userLng, currentProject.lat, currentProject.lng);
            const allowedRadius = currentProject.radius || 50;
            
            $('attLat').value = userLat;
            $('attLng').value = userLng;
            $('attDist').value = Math.round(distance);
            
            // Add user marker
            L.marker([userLat, userLng], {
                icon: L.divIcon({
                    html: '<i class="fas fa-user-circle" style="color:#28a745;font-size:28px"></i>',
                    iconSize: [28, 28],
                    className: ''
                })
            }).addTo(leafletMap).bindPopup('Your Location');
            
            leafletMap.fitBounds([[userLat, userLng], [currentProject.lat, currentProject.lng]], { padding: [40, 40] });
            
            if (distance <= allowedRadius) {
                $('locationStatus').className = 'loc-box ok';
                $('locationStatus').innerHTML = `<i class="fas fa-check-circle text-success"></i><div><strong>Location Verified!</strong><br><small>You are ${Math.round(distance)}m from the site</small></div>`;
                $('attVerified').value = 'true';
                $('saveAttendanceBtn').disabled = false;
                $('attendanceForm').classList.remove('hide');
            } else {
                $('locationStatus').className = 'loc-box no';
                $('locationStatus').innerHTML = `<i class="fas fa-times-circle text-danger"></i><div><strong>Too Far Away!</strong><br><small>You are ${Math.round(distance)}m from the site (max: ${allowedRadius}m)</small></div>`;
                $('attVerified').value = 'false';
                $('retryLocationBtn').classList.remove('hide');
            }
        },
        error => {
            showLocationError(error.message);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
}

function showLocationError(message) {
    $('locationStatus').className = 'loc-box no';
    $('locationStatus').innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i><div><strong>Location Error</strong><br><small>${message}</small></div>`;
    $('retryLocationBtn').classList.remove('hide');
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Earth's radius in meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function saveAttendance() {
    const recordData = {
        formType: 'attendance',
        projectKey: currentProject.key,
        userKey: currentUser.key,
        date: $('attDate').value,
        timeIn: $('attTimeIn').value,
        timeOut: $('attTimeOut').value,
        work: $('attWork').value,
        remarks: $('attRemarks').value,
        location: {
            lat: parseFloat($('attLat').value) || 0,
            lng: parseFloat($('attLng').value) || 0,
            distance: parseInt($('attDist').value) || 0,
            verified: $('attVerified').value === 'true',
            skipped: $('attVerified').value === 'skipped'
        },
        createdAt: Date.now()
    };
    
    DB.ref('records').push(recordData)
        .then(() => {
            bootstrap.Modal.getInstance($('attendanceModal')).hide();
            showToast('Attendance saved successfully!');
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save attendance', 'error');
        });
}

// ==================== RECORDS PAGE ====================
function loadRecordsPage() {
    let records = RECORDS;
    
    // Filter by role
    if (currentUser.role === 'staff') {
        records = records.filter(r => r.userKey === currentUser.key);
    } else if (currentUser.role === 'client') {
        records = records.filter(r => r.projectKey === currentUser.projectKey);
    }
    
    // Apply filters
    const fromDate = $('filterFrom').value;
    const toDate = $('filterTo').value;
    const typeFilter = $('filterType').value;
    
    if (fromDate) records = records.filter(r => r.date >= fromDate);
    if (toDate) records = records.filter(r => r.date <= toDate);
    if (typeFilter) records = records.filter(r => r.formType === typeFilter);
    
    // Sort by date desc
    records.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    
    // Update type filter options
    const types = [...new Set(RECORDS.map(r => r.formType))];
    $('filterType').innerHTML = '<option value="">All Types</option>' + 
        types.map(t => `<option value="${t}">${getFormTypeName(t)}</option>`).join('');
    
    // Render table
    if (records.length > 0) {
        $('recordsTableBody').innerHTML = records.map(record => {
            const project = PROJECTS.find(p => p.key === record.projectKey);
            const user = USERS.find(u => u.key === record.userKey);
            
            let locationBadge = '';
            if (record.formType === 'attendance') {
                if (record.location?.verified) {
                    locationBadge = '<i class="fas fa-map-marker-alt text-success ms-1" title="GPS Verified"></i>';
                } else if (record.location?.skipped) {
                    locationBadge = '<i class="fas fa-ban text-secondary ms-1" title="GPS Skipped"></i>';
                }
            }
            
            return `
                <tr>
                    <td>${formatDate(record.date)}</td>
                    <td>${project?.name || '-'}</td>
                    <td><span class="badge bg-primary">${getFormTypeName(record.formType)}</span>${locationBadge}</td>
                    <td>${user?.name || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRecord('${record.key}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-success" onclick="printRecord('${record.key}')"><i class="fas fa-print"></i></button>
                        ${currentUser.role === 'admin' ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${record.key}')"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        $('recordsTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No records found</td></tr>';
    }
}

function viewRecord(recordKey) {
    const record = RECORDS.find(r => r.key === recordKey);
    const project = PROJECTS.find(p => p.key === record?.projectKey);
    const user = USERS.find(u => u.key === record?.userKey);
    
    if (!record) return;
    
    $('viewModalBody').innerHTML = generateReportHTML(record, project, user);
    new bootstrap.Modal($('viewModal')).show();
}

function printRecord(recordKey) {
    viewRecord(recordKey);
    setTimeout(() => window.print(), 500);
}

function deleteRecord(recordKey) {
    if (confirm('Are you sure you want to delete this record?')) {
        DB.ref('records/' + recordKey).remove()
            .then(() => showToast('Record deleted'))
            .catch(error => {
                console.error('Delete error:', error);
                showToast('Failed to delete record', 'error');
            });
    }
}

function generateReportHTML(record, project, user) {
    let contentHTML = '';
    
    if (record.formType === 'attendance') {
        let locationStatus = '';
        if (record.location?.verified) {
            locationStatus = `<div class="alert alert-success py-2"><i class="fas fa-check-circle me-1"></i>GPS Verified - ${record.location.distance}m from site</div>`;
        } else if (record.location?.skipped) {
            locationStatus = `<div class="alert alert-secondary py-2"><i class="fas fa-info-circle me-1"></i>GPS Authentication Skipped</div>`;
        }
        
        contentHTML = `
            ${locationStatus}
            <div class="summary-cards" style="grid-template-columns: 1fr 1fr;">
                <div class="summary-card"><div class="value">${record.timeIn || '-'}</div><div class="label">Time In</div></div>
                <div class="summary-card"><div class="value">${record.timeOut || '-'}</div><div class="label">Time Out</div></div>
            </div>
            <div class="card mb-3"><div class="card-body"><strong>Work Done:</strong><br>${record.work || 'N/A'}</div></div>
        `;
    } else if (record.formType === 'insecticide') {
        contentHTML = `
            <div class="summary-cards">
                <div class="summary-card"><div class="value">${record.chemical || '-'}</div><div class="label">Chemical</div></div>
                <div class="summary-card"><div class="value">${record.qty || '-'} ml</div><div class="label">Quantity</div></div>
                <div class="summary-card"><div class="value">${record.water || '-'} L</div><div class="label">Water</div></div>
                <div class="summary-card"><div class="value">${(record.areas || []).length}</div><div class="label">Areas</div></div>
            </div>
            <div class="card mb-3"><div class="card-body"><strong>Areas Treated:</strong><br>${(record.areas || []).join(', ') || 'N/A'}</div></div>
        `;
    } else if (record.formType === 'checklist') {
        contentHTML = `
            <div class="summary-cards" style="grid-template-columns: 1fr 1fr;">
                <div class="summary-card"><div class="value">${record.timeIn || '-'}</div><div class="label">Time In</div></div>
                <div class="summary-card"><div class="value">${record.timeOut || '-'}</div><div class="label">Time Out</div></div>
            </div>
            <table class="table table-sm">
                <thead><tr><th>#</th><th>Activity</th><th>Status</th></tr></thead>
                <tbody>
                    ${(record.activities || []).map((act, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${act.item}</td>
                            <td><span class="badge ${act.status === 'done' ? 'bg-success' : act.status === 'pending' ? 'bg-warning' : 'bg-secondary'}">${act.status}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } else {
        contentHTML = `
            <table class="table table-sm table-bordered">
                <thead><tr><th>#</th><th>Location</th><th>Count</th><th>Status</th></tr></thead>
                <tbody>
                    ${(record.entries || []).map(entry => `
                        <tr>
                            <td>${entry.sr}</td>
                            <td>${entry.location}</td>
                            <td>${entry.count}</td>
                            <td><span class="badge ${entry.status === 'ok' ? 'bg-success' : 'bg-warning'}">${entry.status}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    return `
        <div class="report-container">
            <div class="report-header">
                <div>
                    <h3>${CONFIG.company.name}</h3>
                    <small>Integrated Pest Management Services</small>
                </div>
                <div class="text-end">
                    <small>${formatDate(record.date)}</small>
                </div>
            </div>
            <div class="report-title">
                <h4><i class="fas fa-file-alt me-2"></i>${getFormTypeName(record.formType)} Report</h4>
            </div>
            <div class="report-body">
                <div class="info-box">
                    <div><label>Project</label><span>${project?.name || '-'}</span></div>
                    <div><label>Client</label><span>${project?.client || '-'}</span></div>
                    <div><label>Date</label><span>${formatDate(record.date)}</span></div>
                    <div><label>Submitted By</label><span>${user?.name || '-'}</span></div>
                </div>
                ${contentHTML}
                ${record.remarks ? `<div class="alert alert-warning"><strong>Remarks:</strong> ${record.remarks}</div>` : ''}
            </div>
        </div>
    `;
}

// ==================== STAFF PAGE ====================
function loadStaffPage() {
    const staffList = USERS.filter(u => u.role === 'staff');
    
    if (staffList.length > 0) {
        $('staffTableBody').innerHTML = staffList.map(staff => {
            const projectNames = (staff.projects || []).map(pk => {
                const proj = PROJECTS.find(p => p.key === pk);
                return proj?.code || '';
            }).filter(Boolean).join(', ');
            
            return `
                <tr>
                    <td>${staff.empId || '-'}</td>
                    <td><strong>${staff.name}</strong></td>
                    <td><code>${staff.username}</code></td>
                    <td>${projectNames || '<span class="text-muted">None</span>'}</td>
                    <td><span class="badge ${staff.active ? 'badge-success' : 'badge-danger'}">${staff.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editStaff('${staff.key}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStaff('${staff.key}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        $('staffTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No staff members found</td></tr>';
    }
}

function openStaffModal() {
    $('staffModalTitle').textContent = 'Add Staff';
    $('staffKey').value = '';
    $('staffEmpId').value = '';
    $('staffName').value = '';
    $('staffUsername').value = '';
    $('staffPassword').value = '';
    $('staffPhone').value = '';
    $('staffActive').checked = true;
    $('staffPassHint').textContent = 'Required for new staff';
    
    // Load projects checkboxes
    $('staffProjectsList').innerHTML = PROJECTS.filter(p => p.active).map(p => `
        <div class="form-check">
            <input class="form-check-input staff-project-check" type="checkbox" value="${p.key}" id="staffProj_${p.key}">
            <label class="form-check-label" for="staffProj_${p.key}">${p.code} - ${p.name}</label>
        </div>
    `).join('') || '<p class="text-muted mb-0">No active projects</p>';
    
    new bootstrap.Modal($('staffModal')).show();
}

function editStaff(staffKey) {
    const staff = USERS.find(u => u.key === staffKey);
    if (!staff) return;
    
    $('staffModalTitle').textContent = 'Edit Staff';
    $('staffKey').value = staff.key;
    $('staffEmpId').value = staff.empId || '';
    $('staffName').value = staff.name;
    $('staffUsername').value = staff.username;
    $('staffPassword').value = '';
    $('staffPhone').value = staff.phone || '';
    $('staffActive').checked = staff.active;
    $('staffPassHint').textContent = 'Leave empty to keep current password';
    
    const assignedProjects = staff.projects || [];
    $('staffProjectsList').innerHTML = PROJECTS.filter(p => p.active).map(p => `
        <div class="form-check">
            <input class="form-check-input staff-project-check" type="checkbox" value="${p.key}" id="staffProj_${p.key}" ${assignedProjects.includes(p.key) ? 'checked' : ''}>
            <label class="form-check-label" for="staffProj_${p.key}">${p.code} - ${p.name}</label>
        </div>
    `).join('') || '<p class="text-muted mb-0">No active projects</p>';
    
    new bootstrap.Modal($('staffModal')).show();
}

function saveStaff() {
    const key = $('staffKey').value;
    const empId = $('staffEmpId').value.trim();
    const name = $('staffName').value.trim();
    const username = $('staffUsername').value.trim().toLowerCase();
    const password = $('staffPassword').value;
    const phone = $('staffPhone').value.trim();
    const active = $('staffActive').checked;
    const projects = [...$$('.staff-project-check:checked')].map(cb => cb.value);
    
    if (!empId || !name || !username) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    if (!key && !password) {
        showToast('Password is required for new staff', 'error');
        return;
    }
    
    // Check duplicate username
    const duplicate = USERS.find(u => u.username.toLowerCase() === username && u.key !== key);
    if (duplicate) {
        showToast('Username already exists', 'error');
        return;
    }
    
    const staffData = {
        empId,
        name,
        username,
        phone,
        role: 'staff',
        projects,
        active,
        updatedAt: Date.now()
    };
    
    if (password) {
        staffData.password = password;
    }
    
    const saveRef = key ? DB.ref('users/' + key) : DB.ref('users').push();
    const saveMethod = key ? 'update' : 'set';
    
    if (!key) {
        staffData.createdAt = Date.now();
    }
    
    saveRef[saveMethod](staffData)
        .then(() => {
            bootstrap.Modal.getInstance($('staffModal')).hide();
            showToast(key ? 'Staff updated successfully' : 'Staff added successfully');
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save staff', 'error');
        });
}

function deleteStaff(staffKey) {
    if (confirm('Are you sure you want to delete this staff member?')) {
        DB.ref('users/' + staffKey).remove()
            .then(() => showToast('Staff deleted'))
            .catch(error => {
                console.error('Delete error:', error);
                showToast('Failed to delete staff', 'error');
            });
    }
}

// ==================== CLIENTS PAGE ====================
function loadClientsPage() {
    const clientsList = USERS.filter(u => u.role === 'client');
    
    if (clientsList.length > 0) {
        $('clientsTableBody').innerHTML = clientsList.map(client => {
            const project = PROJECTS.find(p => p.key === client.projectKey);
            return `
                <tr>
                    <td><code>${client.username}</code></td>
                    <td><strong>${client.name}</strong></td>
                    <td>${project?.name || '<span class="text-muted">Not assigned</span>'}</td>
                    <td><span class="badge ${client.active ? 'badge-success' : 'badge-danger'}">${client.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editClient('${client.key}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${client.key}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    } else {
        $('clientsTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No client accounts found</td></tr>';
    }
}

function openClientModal() {
    $('clientModalTitle').textContent = 'Add Client';
    $('clientKey').value = '';
    $('clientName').value = '';
    $('clientUsername').value = '';
    $('clientPassword').value = '';
    $('clientActive').checked = true;
    $('clientPassHint').textContent = 'Required for new client';
    
    $('clientProject').innerHTML = '<option value="">-- Select Project --</option>' + 
        PROJECTS.filter(p => p.active).map(p => `<option value="${p.key}">${p.name}</option>`).join('');
    
    new bootstrap.Modal($('clientModal')).show();
}

function editClient(clientKey) {
    const client = USERS.find(u => u.key === clientKey);
    if (!client) return;
    
    $('clientModalTitle').textContent = 'Edit Client';
    $('clientKey').value = client.key;
    $('clientName').value = client.name;
    $('clientUsername').value = client.username;
    $('clientPassword').value = '';
    $('clientActive').checked = client.active;
    $('clientPassHint').textContent = 'Leave empty to keep current password';
    
    $('clientProject').innerHTML = '<option value="">-- Select Project --</option>' + 
        PROJECTS.filter(p => p.active).map(p => 
            `<option value="${p.key}" ${p.key === client.projectKey ? 'selected' : ''}>${p.name}</option>`
        ).join('');
    
    new bootstrap.Modal($('clientModal')).show();
}

function saveClient() {
    const key = $('clientKey').value;
    const name = $('clientName').value.trim();
    const username = $('clientUsername').value.trim().toLowerCase();
    const password = $('clientPassword').value;
    const projectKey = $('clientProject').value;
    const active = $('clientActive').checked;
    
    if (!name || !username || !projectKey) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    if (!key && !password) {
        showToast('Password is required for new client', 'error');
        return;
    }
    
    const duplicate = USERS.find(u => u.username.toLowerCase() === username && u.key !== key);
    if (duplicate) {
        showToast('Username already exists', 'error');
        return;
    }
    
    const clientData = {
        name,
        username,
        projectKey,
        role: 'client',
        active,
        updatedAt: Date.now()
    };
    
    if (password) {
        clientData.password = password;
    }
    
    const saveRef = key ? DB.ref('users/' + key) : DB.ref('users').push();
    const saveMethod = key ? 'update' : 'set';
    
    if (!key) {
        clientData.createdAt = Date.now();
    }
    
    saveRef[saveMethod](clientData)
        .then(() => {
            bootstrap.Modal.getInstance($('clientModal')).hide();
            showToast(key ? 'Client updated successfully' : 'Client added successfully');
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save client', 'error');
        });
}

function deleteClient(clientKey) {
    if (confirm('Are you sure you want to delete this client account?')) {
        DB.ref('users/' + clientKey).remove()
            .then(() => showToast('Client deleted'))
            .catch(error => {
                console.error('Delete error:', error);
                showToast('Failed to delete client', 'error');
            });
    }
}

// ==================== PROJECTS PAGE ====================
function loadProjectsPage() {
    if (PROJECTS.length > 0) {
        $('projectsTableBody').innerHTML = PROJECTS.map(project => `
            <tr>
                <td><strong>${project.code}</strong></td>
                <td>${project.name}</td>
                <td>${project.client}</td>
                <td>${project.gpsEnabled ? '<span class="badge bg-success">Enabled</span>' : '<span class="badge bg-secondary">Disabled</span>'}</td>
                <td><span class="badge ${project.active ? 'badge-success' : 'badge-danger'}">${project.active ? 'Active' : 'Inactive'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editProject('${project.key}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProject('${project.key}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } else {
        $('projectsTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No projects found</td></tr>';
    }
}

function openProjectModal() {
    $('projectModalTitle').textContent = 'Add Project';
    $('projectKey').value = '';
    $('projectCode').value = '';
    $('projectName').value = '';
    $('projectClient').value = '';
    $('projectContact').value = '';
    $('projectAddress').value = '';
    $('projectLat').value = '';
    $('projectLng').value = '';
    $('projectRadius').value = '50';
    $('projectGpsEnabled').checked = false;
    $('projectActive').checked = true;
    
    new bootstrap.Modal($('projectModal')).show();
}

function editProject(projectKey) {
    const project = PROJECTS.find(p => p.key === projectKey);
    if (!project) return;
    
    $('projectModalTitle').textContent = 'Edit Project';
    $('projectKey').value = project.key;
    $('projectCode').value = project.code;
    $('projectName').value = project.name;
    $('projectClient').value = project.client;
    $('projectContact').value = project.contact || '';
    $('projectAddress').value = project.address || '';
    $('projectLat').value = project.lat || '';
    $('projectLng').value = project.lng || '';
    $('projectRadius').value = project.radius || 50;
    $('projectGpsEnabled').checked = project.gpsEnabled || false;
    $('projectActive').checked = project.active;
    
    new bootstrap.Modal($('projectModal')).show();
}

function saveProject() {
    const key = $('projectKey').value;
    const code = $('projectCode').value.trim();
    const name = $('projectName').value.trim();
    const client = $('projectClient').value.trim();
    
    if (!code || !name || !client) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    const projectData = {
        code,
        name,
        client,
        contact: $('projectContact').value.trim(),
        address: $('projectAddress').value.trim(),
        lat: parseFloat($('projectLat').value) || null,
        lng: parseFloat($('projectLng').value) || null,
        radius: parseInt($('projectRadius').value) || 50,
        gpsEnabled: $('projectGpsEnabled').checked,
        active: $('projectActive').checked,
        updatedAt: Date.now()
    };
    
    const saveRef = key ? DB.ref('projects/' + key) : DB.ref('projects').push();
    const saveMethod = key ? 'update' : 'set';
    
    if (!key) {
        projectData.createdAt = Date.now();
    }
    
    saveRef[saveMethod](projectData)
        .then(() => {
            bootstrap.Modal.getInstance($('projectModal')).hide();
            showToast(key ? 'Project updated successfully' : 'Project added successfully');
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save project', 'error');
        });
}

function deleteProject(projectKey) {
    if (confirm('Are you sure you want to delete this project?')) {
        DB.ref('projects/' + projectKey).remove()
            .then(() => showToast('Project deleted'))
            .catch(error => {
                console.error('Delete error:', error);
                showToast('Failed to delete project', 'error');
            });
    }
}

function captureLocation() {
    if (!navigator.geolocation) {
        showToast('Geolocation not supported', 'error');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        position => {
            $('projectLat').value = position.coords.latitude.toFixed(6);
            $('projectLng').value = position.coords.longitude.toFixed(6);
            showToast('Location captured successfully');
        },
        error => {
            showToast('Error getting location: ' + error.message, 'error');
        },
        { enableHighAccuracy: true }
    );
}

// ==================== REMARKS PAGE (ADMIN ONLY) ====================
function loadRemarksPage() {
    if (REMARKS.length > 0) {
        $('remarksContent').innerHTML = REMARKS.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).map(remark => {
            const user = USERS.find(u => u.key === remark.userKey);
            const project = PROJECTS.find(p => p.key === remark.projectKey);
            return `
                <div class="remarks-section mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1"><i class="fas fa-user me-1"></i>${user?.name || 'Unknown'}</h6>
                            <small class="text-muted">${project?.name || 'Unknown Project'}  ${formatDateTime(remark.createdAt)}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRemark('${remark.key}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <p class="mt-2 mb-0">${remark.text}</p>
                </div>
            `;
        }).join('');
    } else {
        $('remarksContent').innerHTML = '<p class="text-muted">No client remarks yet</p>';
    }
}

function openRemarkModal() {
    $('remarkText').value = '';
    new bootstrap.Modal($('remarkModal')).show();
}

function saveRemark() {
    const text = $('remarkText').value.trim();
    if (!text) {
        showToast('Please enter your remark', 'error');
        return;
    }
    
    DB.ref('remarks').push({
        text,
        userKey: currentUser.key,
        projectKey: currentUser.projectKey,
        createdAt: Date.now()
    })
    .then(() => {
        bootstrap.Modal.getInstance($('remarkModal')).hide();
        showToast('Your remark has been submitted');
    })
    .catch(error => {
        console.error('Save error:', error);
        showToast('Failed to submit remark', 'error');
    });
}

function deleteRemark(remarkKey) {
    if (confirm('Delete this remark?')) {
        DB.ref('remarks/' + remarkKey).remove()
            .then(() => showToast('Remark deleted'))
            .catch(error => showToast('Failed to delete', 'error'));
    }
}

// ==================== SETTINGS PAGE ====================
function loadSettingsPage() {
    $('settingsName').value = currentUser.name;
    $('settingsPass').value = '';
}

function saveSettings() {
    const name = $('settingsName').value.trim();
    const password = $('settingsPass').value;
    
    if (!name) {
        showToast('Name is required', 'error');
        return;
    }
    
    const updates = { name, updatedAt: Date.now() };
    if (password) {
        updates.password = password;
    }
    
    DB.ref('users/' + currentUser.key).update(updates)
        .then(() => {
            currentUser.name = name;
            $('headerUserName').textContent = name;
            $('headerUserAvatar').textContent = name.charAt(0).toUpperCase();
            showToast('Settings saved successfully');
        })
        .catch(error => {
            console.error('Save error:', error);
            showToast('Failed to save settings', 'error');
        });
}

function exportAllData() {
    const exportData = {
        users: USERS,
        projects: PROJECTS,
        records: RECORDS,
        remarks: REMARKS,
        exportedAt: new Date().toISOString(),
        exportedBy: currentUser.name
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `a2z_ipm_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showToast('Data exported successfully');
}

function clearAllData() {
    if (confirm(' WARNING: This will delete ALL data permanently!\n\nAre you absolutely sure?')) {
        if (confirm('This action cannot be undone. Type "DELETE" mentally and click OK to proceed.')) {
            Promise.all([
                DB.ref('users').remove(),
                DB.ref('projects').remove(),
                DB.ref('records').remove(),
                DB.ref('remarks').remove()
            ])
            .then(() => {
                localStorage.clear();
                showToast('All data cleared');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('Clear error:', error);
                showToast('Failed to clear data', 'error');
            });
        }
    }
}

// ==================== START APPLICATION ====================
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
