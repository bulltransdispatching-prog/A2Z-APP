<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2Z IPM System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--p:#004080;--s:#002b55;--g:#28a745;--r:#dc3545}
        *{box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:#f5f5f5;margin:0}
        .hide{display:none!important}
        
        .login-wrap{min-height:100vh;background:linear-gradient(135deg,var(--p),var(--s));display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:#fff;border-radius:15px;padding:30px;width:100%;max-width:360px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
        .login-box h2{color:var(--p);text-align:center;margin-bottom:5px;font-weight:700}
        .app-sub{text-align:center;color:#666;font-size:0.9rem;margin-bottom:25px;font-weight:500}
        
        .sidebar{position:fixed;left:0;top:0;width:250px;height:100vh;background:linear-gradient(180deg,var(--p),var(--s));color:#fff;z-index:100;overflow-y:auto;transition:transform .3s}
        .sidebar.closed{transform:translateX(-250px)}
        .sidebar h4{padding:20px;margin:0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.2rem}
        .nav-item{padding:12px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;border-left:3px solid transparent;transition:all .2s}
        .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.1);border-left-color:#f0ad4e}
        .nav-item i{width:20px}
        .nav-section{padding:10px 20px;font-size:.7rem;text-transform:uppercase;opacity:.5;margin-top:10px}
        
        .main{margin-left:250px;min-height:100vh;transition:margin .3s}
        .main.full{margin-left:0}
        .topbar{background:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.05);position:sticky;top:0;z-index:50}
        .content{padding:20px}
        .toggle-btn{background:none;border:none;font-size:1.3rem;color:var(--p);cursor:pointer}
        
        .card{border:none;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:20px}
        .card-header{background:var(--p);color:#fff;padding:12px 15px;border-radius:12px 12px 0 0!important;font-weight:600}
        .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background:#fff;border-radius:12px;padding:20px;display:flex;align-items:center;gap:15px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .stat-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.3rem}
        .stat-icon.blue{background:linear-gradient(135deg,#667eea,#764ba2)}
        .stat-icon.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
        .stat-icon.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
        .stat-icon.purple{background:linear-gradient(135deg,#4facfe,#00f2fe)}
        .stat-info h3{margin:0;font-size:1.5rem;font-weight:700}
        .stat-info p{margin:0;color:#888;font-size:.85rem}
        
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
        .form-card{background:#fff;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent}
        .form-card:hover{border-color:var(--p);transform:translateY(-3px);box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .form-card i{font-size:2.5rem;color:var(--p);margin-bottom:10px}
        .form-card h6{margin:0;font-weight:600}
        
        .table{margin:0}
        .table th{background:#f8f9fa;font-weight:600;font-size:.85rem}
        .badge-ok{background:#d4edda;color:#155724}
        .badge-no{background:#f8d7da;color:#721c24}
        
        .loc-status{padding:15px;border-radius:10px;display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .loc-status.ok{background:#d4edda;border:2px solid var(--g)}
        .loc-status.no{background:#f8d7da;border:2px solid var(--r)}
        .loc-status.wait{background:#cce5ff;border:2px solid #007bff}
        .loc-status i{font-size:1.5rem}
        #attMap{height:250px;border-radius:10px;margin-bottom:15px}
        
        .report{background:#fff;max-width:800px;margin:0 auto}
        .report-head{background:var(--p);color:#fff;padding:20px;display:flex;justify-content:space-between}
        .report-head h3{margin:0;font-weight:700}
        .report-title{background:#f8f9fa;padding:12px 20px;border-bottom:3px solid var(--p)}
        .report-title h4{margin:0;color:var(--p);font-weight:700}
        .report-body{padding:20px}
        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid var(--p)}
        .info-item label{font-size:.7rem;text-transform:uppercase;color:#666}
        .info-item span{display:block;font-weight:500}
        .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
        .summary-box{background:#f8f9fa;padding:15px;text-align:center;border-radius:8px;border-left:3px solid var(--p)}
        .summary-box .num{font-size:1.8rem;font-weight:700;color:var(--p)}
        .summary-box .lbl{font-size:.75rem;color:#666}
        .report-footer{background:#f8f9fa;padding:15px 20px;font-size:.8rem;color:#666}
        
        @media(max-width:768px){
            .sidebar{transform:translateX(-250px)}
            .sidebar.open{transform:translateX(0)}
            .main{margin-left:0}
            .summary-grid{grid-template-columns:repeat(2,1fr)}
            .info-grid{grid-template-columns:1fr}
        }
        
        @media print{
            .sidebar,.topbar,.no-print{display:none!important}
            .main{margin:0!important}
            .content{padding:0!important}
        }
        
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
        .overlay.show{display:block}
        .user-avatar{width:35px;height:35px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
        
        .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
        .toast{background:#fff;border-radius:8px;padding:15px 20px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideIn .3s}
        .toast.success{border-left:4px solid var(--g)}
        .toast.error{border-left:4px solid var(--r)}
        .toast.info{border-left:4px solid #17a2b8}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        .sync-status{position:fixed;bottom:20px;right:20px;padding:8px 15px;border-radius:20px;font-size:.8rem;display:flex;align-items:center;gap:8px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .sync-status.online{background:#d4edda;color:#155724}
        .sync-status.offline{background:#f8d7da;color:#721c24}
        .sync-status.syncing{background:#fff3cd;color:#856404}
        .sync-dot{width:8px;height:8px;border-radius:50%;animation:pulse 1.5s infinite}
        .online .sync-dot{background:#28a745}
        .offline .sync-dot{background:#dc3545}
        .syncing .sync-dot{background:#ffc107}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    </style>
</head>
<body>

<div class="toast-container" id="toasts"></div>

<div class="sync-status online" id="syncStatus">
    <div class="sync-dot"></div>
    <span id="syncText">Online</span>
</div>

<!-- LOGIN -->
<div id="loginPage" class="login-wrap">
    <div class="login-box">
        <h2>A2Z IPM</h2>
        <div class="app-sub">A2Z Industrial Solutions App</div>
        <div id="loginErr" class="alert alert-danger hide">Invalid credentials</div>
        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" id="uname" class="form-control" required autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <div class="input-group">
                    <input type="password" id="pwd" class="form-control" required autocomplete="off">
                    <button type="button" class="btn btn-outline-secondary" onclick="togglePwd()"><i class="fas fa-eye" id="pwdIcon"></i></button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginBtn"><i class="fas fa-sign-in-alt me-2"></i>Login</button>
        </form>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" class="hide">
    <div class="overlay" id="overlay" onclick="toggleNav()"></div>
    
    <nav class="sidebar" id="sidebar">
        <h4><i class="fas fa-bug me-2"></i>A2Z IPM</h4>
        <div class="nav-item active" data-p="dash"><i class="fas fa-home"></i><span>Dashboard</span></div>
        <div class="nav-item staff-menu" data-p="entry"><i class="fas fa-edit"></i><span>Data Entry</span></div>
        <div class="nav-item" data-p="records"><i class="fas fa-list"></i><span>Records</span></div>
        <div class="nav-section admin-menu">Admin</div>
        <div class="nav-item admin-menu" data-p="staff"><i class="fas fa-users"></i><span>Staff</span></div>
        <div class="nav-item admin-menu" data-p="clients"><i class="fas fa-handshake"></i><span>Clients</span></div>
        <div class="nav-item admin-menu" data-p="projects"><i class="fas fa-building"></i><span>Projects</span></div>
        <div class="nav-section">Account</div>
        <div class="nav-item" data-p="settings"><i class="fas fa-cog"></i><span>Settings</span></div>
        <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
    </nav>
    
    <div class="main" id="main">
        <div class="topbar no-print">
            <button class="toggle-btn" onclick="toggleNav()"><i class="fas fa-bars"></i></button>
            <div class="d-flex align-items-center gap-2">
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold" id="userName"></div>
                    <small class="text-muted" id="userRole"></small>
                </div>
                <div class="user-avatar" id="userAv">A</div>
            </div>
        </div>
        
        <div class="content">
            <!-- Dashboard -->
            <div id="pg-dash" class="page">
                <h5 class="mb-3">Dashboard</h5>
                <div class="stat-grid" id="stats"></div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-clock me-2"></i>Recent Activity</div>
                    <div class="card-body" id="activity"><p class="text-muted mb-0">No activity</p></div>
                </div>
            </div>
            
            <!-- Data Entry -->
            <div id="pg-entry" class="page hide">
                <h5 class="mb-3">Data Entry</h5>
                <div class="card mb-3">
                    <div class="card-body">
                        <label class="form-label">Select Project</label>
                        <select id="selProject" class="form-select"></select>
                    </div>
                </div>
                <div class="form-grid" id="formCards"></div>
            </div>
            
            <!-- Records -->
            <div id="pg-records" class="page hide">
                <h5 class="mb-3" id="recTitle">Records</h5>
                <div class="card mb-3 no-print">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="date" id="fFrom" class="form-control"></div>
                            <div class="col-md-3"><input type="date" id="fTo" class="form-control"></div>
                            <div class="col-md-3"><select id="fType" class="form-select"><option value="">All Types</option></select></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="loadRecords()"><i class="fas fa-search"></i> Filter</button></div>
                        </div>
                    </div>
                </div>
                <div class="card no-print">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Date</th><th>Project</th><th>Type</th><th>By</th><th>Actions</th></tr></thead>
                                <tbody id="recBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Management -->
            <div id="pg-staff" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Staff Management</h5>
                    <button class="btn btn-primary btn-sm" onclick="openStaffModal()"><i class="fas fa-plus"></i> Add Staff</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Emp ID</th><th>Name</th><th>Username</th><th>Projects</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="staffBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Client Management -->
            <div id="pg-clients" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Client Accounts</h5>
                    <button class="btn btn-primary btn-sm" onclick="openClientModal()"><i class="fas fa-plus"></i> Add Client</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Username</th><th>Client Name</th><th>Project</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="clientBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Projects -->
            <div id="pg-projects" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Projects</h5>
                    <button class="btn btn-primary btn-sm" onclick="openProjModal()"><i class="fas fa-plus"></i> Add Project</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Code</th><th>Name</th><th>Client</th><th>GPS Auth</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="projBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div id="pg-settings" class="page hide">
                <h5 class="mb-3">Settings</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-user me-2"></i>My Profile</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" id="setName" class="form-control">
                                </div>
                                <div class="mb-3" id="pwdSetDiv">
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="setPass" class="form-control" placeholder="Leave empty to keep current">
                                </div>
                                <div id="pwdMsg" class="alert alert-warning small mb-3 hide">Contact Admin to change password.</div>
                                <button class="btn btn-primary" onclick="saveProfile()"><i class="fas fa-save me-1"></i>Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 admin-menu">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-database me-2"></i>Data</div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="syncNow()"><i class="fas fa-sync me-1"></i>Sync Now</button>
                                <button class="btn btn-outline-success w-100 mb-2" onclick="exportData()"><i class="fas fa-download me-1"></i>Export All Data</button>
                                <button class="btn btn-outline-danger w-100" onclick="clearData()"><i class="fas fa-trash me-1"></i>Clear All Data</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><i class="fas fa-users me-2"></i>All Users</div>
                            <div class="card-body" id="allUsersList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Staff Modal -->
<div class="modal fade" id="staffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sId">
                <input type="hidden" id="sFbKey">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Employee ID <span class="text-danger">*</span></label>
                        <input type="text" id="sEmpId" class="form-control" required placeholder="e.g., PCO001">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" id="sName" class="form-control" required placeholder="e.g., Ali Khan">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" id="sUser" class="form-control" required placeholder="e.g., ali">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="text" id="sPwd" class="form-control" placeholder="Enter password">
                        <small class="text-muted" id="sPwdHint">Required for new staff</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input type="text" id="sPhone" class="form-control" placeholder="e.g., 0300-1234567">
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Projects</label>
                    <div id="sProjList" class="border rounded p-2" style="max-height:150px;overflow-y:auto"></div>
                    <small class="text-muted">Select projects this staff can access</small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="sActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()"><i class="fas fa-save me-1"></i>Save Staff</button>
            </div>
        </div>
    </div>
</div>

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="clientModalTitle">Add Client Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cId">
                <input type="hidden" id="cFbKey">
                <div class="mb-3">
                    <label class="form-label">Client/Company Name <span class="text-danger">*</span></label>
                    <input type="text" id="cName" class="form-control" required placeholder="e.g., MBC Pvt Ltd">
                </div>
                <div class="mb-3">
                    <label class="form-label">Username <span class="text-danger">*</span></label>
                    <input type="text" id="cUser" class="form-control" required placeholder="e.g., mbc">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <input type="text" id="cPwd" class="form-control" placeholder="Enter password">
                    <small class="text-muted" id="cPwdHint">Required for new client</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Project <span class="text-danger">*</span></label>
                    <select id="cProj" class="form-select" required>
                        <option value="">-- Select Project --</option>
                    </select>
                    <small class="text-muted">Client can only view this project's data</small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="cActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveClient()"><i class="fas fa-save me-1"></i>Save Client</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal fade" id="projModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="projModalTitle">Add Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <input type="hidden" id="pFbKey">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Code <span class="text-danger">*</span></label>
                        <input type="text" id="pCode" class="form-control" required placeholder="e.g., PRJ001">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Name <span class="text-danger">*</span></label>
                        <input type="text" id="pName" class="form-control" required placeholder="e.g., ABC Factory">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client Name <span class="text-danger">*</span></label>
                        <input type="text" id="pClient" class="form-control" required placeholder="e.g., ABC Pvt Ltd">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" id="pContact" class="form-control" placeholder="e.g., Mr. Ahmed">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <input type="text" id="pAddr" class="form-control" placeholder="e.g., Industrial Area, Lahore">
                </div>
                <div class="card bg-light mb-3">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-map-marker-alt me-1"></i>GPS Location</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="pGpsEnabled">
                            <label class="form-check-label" for="pGpsEnabled">Enable Auth</label>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="alert alert-info py-1 small mb-2"><i class="fas fa-info-circle"></i> Enable Auth to force GPS check for Attendance.</div>
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label small">Latitude</label>
                                <input type="number" step="any" id="pLat" class="form-control form-control-sm" placeholder="31.5204">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Longitude</label>
                                <input type="number" step="any" id="pLng" class="form-control form-control-sm" placeholder="74.3587">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Radius (m)</label>
                                <input type="number" id="pRad" class="form-control form-control-sm" value="50" min="10" max="500">
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="getMyLoc()">
                            <i class="fas fa-crosshairs me-1"></i>Use My Location
                        </button>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="pActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProj()"><i class="fas fa-save me-1"></i>Save Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Form Entry Modal -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="formTitle">Form</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="formBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveForm()"><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal fade" id="attModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Attendance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="gpsSection">
                    <div id="locStatus" class="loc-status wait">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <div><strong>Checking location...</strong><br><small>Please allow access</small></div>
                    </div>
                    <div id="attMap"></div>
                </div>
                <div id="attForm" class="hide">
                    <div class="alert alert-info py-2" id="gpsSkipMsg" style="display:none"><i class="fas fa-info-circle"></i> GPS Authentication is disabled for this project.</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" id="aDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time In</label>
                            <input type="time" id="aIn" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time Out</label>
                            <input type="time" id="aOut" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Work Done</label>
                        <textarea id="aWork" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea id="aRem" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <input type="hidden" id="aLat">
                <input type="hidden" id="aLng">
                <input type="hidden" id="aDist">
                <input type="hidden" id="aVerified">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary hide" id="retryBtn" onclick="checkLoc()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="attSaveBtn" onclick="saveAtt()" disabled>
                    <i class="fas fa-save me-1"></i>Save Attendance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">View Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="viewBody"></div>
            <div class="modal-footer no-print">
                <button class="btn btn-outline-primary" onclick="window.print()"><i class="fas fa-print me-1"></i>Print</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ============== CONFIG ==============
const DB_NAME = 'A2Z_IPM_v11';
const COMPANY = {
    name: 'A2Z Industrial Solutions',
    addr: '30-F, J-1 Market, Wapda Town, Lahore',
    phone: '0307-0430056',
    email: 'info@a2zidsolutions.com'
};

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCMBoABKBWTOx1B6zEBCk7QCeTKogUYgxQ",
    authDomain: "a2z-ipm.firebaseapp.com",
    databaseURL: "https://a2z-ipm-default-rtdb.firebaseio.com",
    projectId: "a2z-ipm",
    storageBucket: "a2z-ipm.firebasestorage.app",
    messagingSenderId: "37433212653",
    appId: "1:37433212653:web:e58af93855931236d456e4"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const fbDB = firebase.database();

let db = null;
let currentUser = null;
let attMap = null;
let curProj = null;
let curForm = null;
let rowCount = 0;
let isOnline = navigator.onLine;
let fbListeners = [];
let currentPage = 'dash';

// ============== HELPERS ==============
const $ = id => document.getElementById(id);
const toast = (msg, type = 'success') => {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'exclamation-circle text-danger' : 'info-circle text-info'}"></i><span>${msg}</span>`;
    $('toasts').appendChild(t);
    setTimeout(() => t.remove(), 3000);
};

function updateSyncStatus(status) {
    const el = $('syncStatus');
    const txt = $('syncText');
    el.className = 'sync-status ' + status;
    txt.textContent = status === 'online' ? 'Online' : status === 'offline' ? 'Offline' : 'Syncing...';
}

window.addEventListener('online', () => { 
    isOnline = true; 
    updateSyncStatus('online'); 
    setupRealtimeListeners();
});

window.addEventListener('offline', () => { 
    isOnline = false; 
    updateSyncStatus('offline');
    removeListeners();
});

// ============== INDEXEDDB ==============
function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => { db = req.result; resolve(db); };
        req.onupgradeneeded = e => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains('users')) d.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
            if (!d.objectStoreNames.contains('projects')) d.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
            if (!d.objectStoreNames.contains('records')) d.createObjectStore('records', { keyPath: 'id', autoIncrement: true });
        };
    });
}

const idbAdd = (store, data) => new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).add({ ...data, createdAt: Date.now() });
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
});

const idbPut = (store, data) => new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put({ ...data, updatedAt: Date.now() });
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
});

const idbDel = (store, id) => new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).delete(id);
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
});

const idbAll = store => new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => res(req.result || []);
    req.onerror = () => rej(req.error);
});

const idbGet = (store, id) => new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(id);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
});

const idbClear = store => new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).clear();
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
});

// ============== FIREBASE OPERATIONS ==============
const fbSet = async (store, key, data) => {
    if (!isOnline) return null;
    try {
        await fbDB.ref(`${store}/${key}`).set({ ...data, updatedAt: Date.now() });
        return key;
    } catch (e) {
        console.error('Firebase set error:', e);
        return null;
    }
};

const fbPush = async (store, data) => {
    if (!isOnline) return null;
    try {
        const ref = fbDB.ref(store).push();
        await ref.set({ ...data, fbKey: ref.key, createdAt: Date.now() });
        return ref.key;
    } catch (e) {
        console.error('Firebase push error:', e);
        return null;
    }
};

const fbDel = async (store, key) => {
    if (!isOnline) return;
    try {
        await fbDB.ref(`${store}/${key}`).remove();
    } catch (e) {
        console.error('Firebase delete error:', e);
    }
};

const fbAll = store => new Promise((res) => {
    fbDB.ref(store).once('value')
        .then(snap => {
            const data = [];
            snap.forEach(child => data.push({ ...child.val(), fbKey: child.key }));
            res(data);
        })
        .catch(e => {
            console.error('Firebase read error:', e);
            res([]);
        });
});

// ============== REALTIME SYNC ==============
function setupRealtimeListeners() {
    if (!isOnline || !currentUser) return;
    
    console.log('ðŸ”„ Setting up realtime sync...');
    removeListeners();
    
    // Users listener
    const usersRef = fbDB.ref('users');
    const usersListener = usersRef.on('value', async (snapshot) => {
        console.log('ðŸ“¥ Users updated from server');
        const fbData = [];
        snapshot.forEach(child => {
            fbData.push({ ...child.val(), fbKey: child.key });
        });
        
        // Update local database
        await idbClear('users');
        for (const item of fbData) {
            try {
                await idbAdd('users', item);
            } catch(e) { console.log('Skip:', e); }
        }
        
        // Refresh current page
        if (currentPage === 'staff') loadStaff();
        if (currentPage === 'clients') loadClients();
        if (currentPage === 'settings') loadSettings();
        if (currentPage === 'dash') loadDash();
    });
    fbListeners.push({ ref: usersRef, type: 'value', callback: usersListener });
    
    // Projects listener
    const projectsRef = fbDB.ref('projects');
    const projectsListener = projectsRef.on('value', async (snapshot) => {
        console.log('ðŸ“¥ Projects updated from server');
        const fbData = [];
        snapshot.forEach(child => {
            fbData.push({ ...child.val(), fbKey: child.key });
        });
        
        await idbClear('projects');
        for (const item of fbData) {
            try {
                await idbAdd('projects', item);
            } catch(e) { console.log('Skip:', e); }
        }
        
        if (currentPage === 'projects') loadProjects();
        if (currentPage === 'entry') loadProjectsDropdown();
        if (currentPage === 'dash') loadDash();
    });
    fbListeners.push({ ref: projectsRef, type: 'value', callback: projectsListener });
    
    // Records listener
    const recordsRef = fbDB.ref('records');
    const recordsListener = recordsRef.on('value', async (snapshot) => {
        console.log('ðŸ“¥ Records updated from server');
        const fbData = [];
        snapshot.forEach(child => {
            fbData.push({ ...child.val(), fbKey: child.key });
        });
        
        await idbClear('records');
        for (const item of fbData) {
            try {
                await idbAdd('records', item);
            } catch(e) { console.log('Skip:', e); }
        }
        
        if (currentPage === 'records') loadRecords();
        if (currentPage === 'dash') loadDash();
    });
    fbListeners.push({ ref: recordsRef, type: 'value', callback: recordsListener });
}

function removeListeners() {
    fbListeners.forEach(listener => {
        listener.ref.off(listener.type, listener.callback);
    });
    fbListeners = [];
}

// ============== DUAL SAVE FUNCTIONS ==============
const dbAdd = async (store, data) => {
    const localId = await idbAdd(store, data);
    
    if (isOnline) {
        try {
            updateSyncStatus('syncing');
            const fbKey = await fbPush(store, { ...data, localId });
            if (fbKey) {
                await idbPut(store, { ...data, id: localId, fbKey });
            }
            updateSyncStatus('online');
        } catch (e) {
            console.error('Sync error:', e);
            updateSyncStatus('online');
        }
    }
    return localId;
};

const dbPut = async (store, data) => {
    await idbPut(store, data);
    
    if (isOnline && data.fbKey) {
        try {
            updateSyncStatus('syncing');
            await fbSet(store, data.fbKey, data);
            updateSyncStatus('online');
        } catch (e) {
            console.error('Sync error:', e);
            updateSyncStatus('online');
        }
    }
};

const dbDel = async (store, id) => {
    const record = await idbGet(store, id);
    await idbDel(store, id);
    
    if (isOnline && record?.fbKey) {
        try {
            updateSyncStatus('syncing');
            await fbDel(store, record.fbKey);
            updateSyncStatus('online');
        } catch (e) {
            console.error('Sync error:', e);
            updateSyncStatus('online');
        }
    }
};

const dbAll = store => idbAll(store);
const dbGet = (store, id) => idbGet(store, id);

// ============== SYNC FROM FIREBASE ==============
async function syncFromFirebase() {
    if (!isOnline) return;
    
    try {
        updateSyncStatus('syncing');
        console.log('ðŸ”„ Initial sync from Firebase...');
        
        // Get all data from Firebase
        const fbUsers = await fbAll('users');
        const fbProjects = await fbAll('projects');
        const fbRecords = await fbAll('records');
        
        // Clear and reload users
        if (fbUsers.length > 0) {
            await idbClear('users');
            for (const u of fbUsers) {
                try {
                    await idbAdd('users', u);
                } catch(e) { console.log('User sync skip:', e); }
            }
        }
        
        // Clear and reload projects
        if (fbProjects.length > 0) {
            await idbClear('projects');
            for (const p of fbProjects) {
                try {
                    await idbAdd('projects', p);
                } catch(e) { console.log('Project sync skip:', e); }
            }
        }
        
        // Clear and reload records
        if (fbRecords.length > 0) {
            await idbClear('records');
            for (const r of fbRecords) {
                try {
                    await idbAdd('records', r);
                } catch(e) { console.log('Record sync skip:', e); }
            }
        }
        
        updateSyncStatus('online');
        console.log('âœ… Initial sync complete');
    } catch (e) {
        console.error('Sync error:', e);
        updateSyncStatus('online');
    }
}

async function syncNow() {
    if (!isOnline) {
        toast('You are offline', 'error');
        return;
    }
    toast('Syncing...', 'info');
    await syncFromFirebase();
    await ensureAdminExists();
    toast('Sync complete!', 'success');
    loadDash();
}

// ============== ENSURE ADMIN EXISTS ==============
async function ensureAdminExists() {
    let users = await idbAll('users');
    const adminExists = users.find(u => u.username === 'admin' && u.role === 'admin');
    
    if (!adminExists) {
        console.log('ðŸ”§ Creating default admin...');
        const adminData = {
            empId: 'ADM001',
            name: 'Administrator',
            username: 'admin',
            password: 'admin123',
            role: 'admin',
            projects: [],
            active: true
        };
        
        // Add to IndexedDB first
        const localId = await idbAdd('users', adminData);
        
        // Try to add to Firebase
        if (isOnline) {
            try {
                const fbKey = await fbPush('users', { ...adminData, localId });
                if (fbKey) {
                    await idbPut('users', { ...adminData, id: localId, fbKey });
                }
            } catch(e) {
                console.log('Could not sync admin to Firebase:', e);
            }
        }
        console.log('âœ… Admin created');
    }
}

// ============== INIT ==============
async function init() {
    try {
        updateSyncStatus(isOnline ? 'online' : 'offline');
        
        // Open IndexedDB
        await openDB();
        console.log('âœ… Database opened');
        
        // Initial sync from Firebase if online
        if (isOnline) {
            await syncFromFirebase();
        }
        
        // ALWAYS ensure admin exists
        await ensureAdminExists();
        
        // Check for existing session
        const session = localStorage.getItem('a2z_session');
        if (session) {
            try {
                const s = JSON.parse(session);
                const users = await idbAll('users');
                const u = users.find(x => x.username === s.username);
                if (u && u.active) {
                    currentUser = u;
                    showApp();
                    if (isOnline) setupRealtimeListeners();
                    return;
                }
            } catch(e) {
                localStorage.removeItem('a2z_session');
            }
        }
        
        $('loginPage').classList.remove('hide');
    } catch (e) {
        console.error('Init error:', e);
        alert('Error initializing app: ' + e.message);
        $('loginPage').classList.remove('hide');
    }
}

// ============== AUTH ==============
$('loginForm').onsubmit = async e => {
    e.preventDefault();
    const username = $('uname').value.trim().toLowerCase();
    const password = $('pwd').value;
    
    $('loginBtn').disabled = true;
    $('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
    $('loginErr').classList.add('hide');
    
    try {
        // Always ensure admin exists before login
        await ensureAdminExists();
        
        const users = await idbAll('users');
        console.log('Checking login. Users in DB:', users.length);
        
        // Find user
        const user = users.find(u => 
            u.username && 
            u.username.toLowerCase() === username && 
            u.password === password && 
            u.active === true
        );
        
        if (user) {
            currentUser = user;
            localStorage.setItem('a2z_session', JSON.stringify({ 
                id: user.id, 
                username: user.username 
            }));
            showApp();
            if (isOnline) setupRealtimeListeners();
            toast('Welcome, ' + user.name);
        } else {
            // Log available usernames for debugging (remove in production)
            console.log('Available users:', users.map(u => u.username));
            $('loginErr').textContent = 'Invalid username or password';
            $('loginErr').classList.remove('hide');
        }
    } catch (e) {
        console.error('Login error:', e);
        $('loginErr').textContent = 'Error: ' + e.message;
        $('loginErr').classList.remove('hide');
    }
    
    $('loginBtn').disabled = false;
    $('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Login';
};

function logout() {
    removeListeners();
    currentUser = null;
    localStorage.removeItem('a2z_session');
    location.reload();
}

function togglePwd() {
    const p = $('pwd'), i = $('pwdIcon');
    if (p.type === 'password') {
        p.type = 'text';
        i.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        p.type = 'password';
        i.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

// ============== UI ==============
function showApp() {
    $('loginPage').classList.add('hide');
    $('app').classList.remove('hide');
    $('userName').textContent = currentUser.name;
    $('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role === 'staff' ? 'PCO/Staff' : 'Client';
    $('userAv').textContent = currentUser.name[0].toUpperCase();
    
    const isAdmin = currentUser.role === 'admin';
    const isClient = currentUser.role === 'client';
    
    document.querySelectorAll('.admin-menu').forEach(el => el.classList.toggle('hide', !isAdmin));
    document.querySelectorAll('.staff-menu').forEach(el => el.classList.toggle('hide', isClient));
    
    $('recTitle').textContent = isClient ? 'Project Records' : 'Records';
    
    loadDash();
    loadProjectsDropdown();
}

function toggleNav() {
    const s = $('sidebar'), o = $('overlay'), m = $('main');
    if (window.innerWidth < 769) {
        s.classList.toggle('open');
        o.classList.toggle('show');
    } else {
        s.classList.toggle('closed');
        m.classList.toggle('full');
    }
}

document.querySelectorAll('.nav-item[data-p]').forEach(n => {
    n.onclick = function() {
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.add('hide'));
        $('pg-' + this.dataset.p).classList.remove('hide');
        
        currentPage = this.dataset.p;
        
        if (currentPage === 'records') loadRecords();
        if (currentPage === 'staff') loadStaff();
        if (currentPage === 'clients') loadClients();
        if (currentPage === 'projects') loadProjects();
        if (currentPage === 'settings') loadSettings();
        
        if (window.innerWidth < 769) toggleNav();
    };
});

// ============== DASHBOARD ==============
async function loadDash() {
    const prj = await dbAll('projects');
    const rec = await dbAll('records');
    const users = await dbAll('users');
    const today = new Date().toISOString().split('T')[0];
    
    let myRec = rec;
    if (currentUser.role === 'staff') {
        myRec = rec.filter(r => r.userId === currentUser.id);
    } else if (currentUser.role === 'client') {
        myRec = rec.filter(r => r.projectId === currentUser.projectId);
    }
    
    let stats = '';
    if (currentUser.role === 'admin') {
        stats = `
            <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-building"></i></div><div class="stat-info"><h3>${prj.filter(p => p.active).length}</h3><p>Projects</p></div></div>
            <div class="stat-card"><div class="stat-icon green"><i class="fas fa-users"></i></div><div class="stat-info"><h3>${users.filter(u => u.role === 'staff' && u.active).length}</h3><p>Staff</p></div></div>
            <div class="stat-card"><div class="stat-icon orange"><i class="fas fa-clipboard"></i></div><div class="stat-info"><h3>${rec.filter(r => r.date === today).length}</h3><p>Today</p></div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${rec.length}</h3><p>Total</p></div></div>
        `;
    } else {
        stats = `
            <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-clipboard"></i></div><div class="stat-info"><h3>${myRec.filter(r => r.date === today).length}</h3><p>Today</p></div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${myRec.length}</h3><p>Total</p></div></div>
        `;
    }
    $('stats').innerHTML = stats;
    
    const recent = myRec.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);
    $('activity').innerHTML = recent.length ? recent.map(r => {
        const p = prj.find(x => x.id === r.projectId);
        return `<div class="d-flex gap-2 border-bottom py-2">
            <i class="fas fa-clipboard-check text-primary"></i>
            <div><strong>${formName(r.formType)}</strong> - ${p?.name || '-'}<br>
            <small class="text-muted">${formatDateTime(r.createdAt)}</small></div>
        </div>`;
    }).join('') : '<p class="text-muted mb-0">No activity yet</p>';
}

// ============== CONTINUE WITH REST OF THE FUNCTIONS... ==============
// [Include all the remaining functions from the original code: loadProjectsDropdown, loadProjects, openProjModal, etc.]
// Due to character limit, I'm showing the key fixes. The rest of the functions remain the same.

function formName(t) {
    const names = {
        attendance: 'Attendance',
        insecticide: 'Insecticide Log',
        gluebox: 'Glue Box',
        efk: 'EFK Monitoring',
        lizard: 'Lizard Trapping',
        cat: 'Cat Trapping',
        snake: 'Snake Box',
        checklist: 'IPM Checklist'
    };
    return names[t] || t;
}

function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB') : '-'; }
function formatDateTime(ts) { return ts ? new Date(ts).toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : '-'; }

// Start the app
init();
</script>
</body>
</html>
