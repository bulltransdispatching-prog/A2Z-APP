<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2Z IPM System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--p:#004080;--s:#002b55;--g:#28a745;--r:#dc3545}
        *{box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:#f5f5f5;margin:0}
        .hide{display:none!important}
        
        .login-wrap{min-height:100vh;background:linear-gradient(135deg,var(--p),var(--s));display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:#fff;border-radius:15px;padding:30px;width:100%;max-width:360px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
        .login-box h2{color:var(--p);text-align:center;margin-bottom:5px;font-weight:700}
        .app-sub{text-align:center;color:#666;font-size:0.9rem;margin-bottom:25px;font-weight:500}
        
        .sidebar{position:fixed;left:0;top:0;width:250px;height:100vh;background:linear-gradient(180deg,var(--p),var(--s));color:#fff;z-index:100;overflow-y:auto;transition:transform .3s}
        .sidebar.closed{transform:translateX(-250px)}
        .sidebar h4{padding:20px;margin:0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.2rem}
        .nav-item{padding:12px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;border-left:3px solid transparent;transition:all .2s}
        .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.1);border-left-color:#f0ad4e}
        .nav-item i{width:20px}
        .nav-section{padding:10px 20px;font-size:.7rem;text-transform:uppercase;opacity:.5;margin-top:10px}
        
        .main{margin-left:250px;min-height:100vh;transition:margin .3s}
        .main.full{margin-left:0}
        .topbar{background:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.05);position:sticky;top:0;z-index:50}
        .content{padding:20px}
        .toggle-btn{background:none;border:none;font-size:1.3rem;color:var(--p);cursor:pointer}
        
        .card{border:none;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:20px}
        .card-header{background:var(--p);color:#fff;padding:12px 15px;border-radius:12px 12px 0 0!important;font-weight:600}
        .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background:#fff;border-radius:12px;padding:20px;display:flex;align-items:center;gap:15px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .stat-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.3rem}
        .stat-icon.blue{background:linear-gradient(135deg,#667eea,#764ba2)}
        .stat-icon.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
        .stat-icon.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
        .stat-icon.purple{background:linear-gradient(135deg,#4facfe,#00f2fe)}
        .stat-info h3{margin:0;font-size:1.5rem;font-weight:700}
        .stat-info p{margin:0;color:#888;font-size:.85rem}
        
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
        .form-card{background:#fff;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent}
        .form-card:hover{border-color:var(--p);transform:translateY(-3px);box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .form-card i{font-size:2.5rem;color:var(--p);margin-bottom:10px}
        .form-card h6{margin:0;font-weight:600}
        
        .table{margin:0}
        .table th{background:#f8f9fa;font-weight:600;font-size:.85rem}
        .badge-ok{background:#d4edda;color:#155724}
        .badge-no{background:#f8d7da;color:#721c24}
        
        .loc-status{padding:15px;border-radius:10px;display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .loc-status.ok{background:#d4edda;border:2px solid var(--g)}
        .loc-status.no{background:#f8d7da;border:2px solid var(--r)}
        .loc-status.wait{background:#cce5ff;border:2px solid #007bff}
        .loc-status i{font-size:1.5rem}
        #attMap{height:250px;border-radius:10px;margin-bottom:15px}
        
        .report{background:#fff;max-width:800px;margin:0 auto}
        .report-head{background:var(--p);color:#fff;padding:20px;display:flex;justify-content:space-between}
        .report-head h3{margin:0;font-weight:700}
        .report-title{background:#f8f9fa;padding:12px 20px;border-bottom:3px solid var(--p)}
        .report-title h4{margin:0;color:var(--p);font-weight:700}
        .report-body{padding:20px}
        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid var(--p)}
        .info-item label{font-size:.7rem;text-transform:uppercase;color:#666}
        .info-item span{display:block;font-weight:500}
        .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
        .summary-box{background:#f8f9fa;padding:15px;text-align:center;border-radius:8px;border-left:3px solid var(--p)}
        .summary-box .num{font-size:1.8rem;font-weight:700;color:var(--p)}
        .summary-box .lbl{font-size:.75rem;color:#666}
        .report-footer{background:#f8f9fa;padding:15px 20px;font-size:.8rem;color:#666}
        
        @media(max-width:768px){
            .sidebar{transform:translateX(-250px)}
            .sidebar.open{transform:translateX(0)}
            .main{margin-left:0}
            .summary-grid{grid-template-columns:repeat(2,1fr)}
            .info-grid{grid-template-columns:1fr}
        }
        
        @media print{
            .sidebar,.topbar,.no-print{display:none!important}
            .main{margin:0!important}
            .content{padding:0!important}
        }
        
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
        .overlay.show{display:block}
        .user-avatar{width:35px;height:35px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
        
        .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
        .toast{background:#fff;border-radius:8px;padding:15px 20px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideIn .3s}
        .toast.success{border-left:4px solid var(--g)}
        .toast.error{border-left:4px solid var(--r)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        .sync-indicator{position:fixed;bottom:20px;right:20px;padding:8px 15px;border-radius:20px;font-size:12px;z-index:9999;display:none}
        .sync-indicator.syncing{display:block;background:#fff3cd;color:#856404}
        .sync-indicator.synced{display:block;background:#d4edda;color:#155724}
        .sync-indicator.error{display:block;background:#f8d7da;color:#721c24}
    </style>
</head>
<body>

<!-- Sync Indicator -->
<div id="syncIndicator" class="sync-indicator"></div>

<!-- Toast Container -->
<div class="toast-container" id="toasts"></div>

<!-- LOGIN -->
<div id="loginPage" class="login-wrap">
    <div class="login-box">
        <h2>A2Z IPM</h2>
        <div class="app-sub">A2Z Industrial Solutions App</div>
        <div id="loginErr" class="alert alert-danger hide">Invalid credentials</div>
        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" id="uname" class="form-control" required autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <div class="input-group">
                    <input type="password" id="pwd" class="form-control" required autocomplete="off">
                    <button type="button" class="btn btn-outline-secondary" onclick="togglePwd()"><i class="fas fa-eye" id="pwdIcon"></i></button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginBtn"><i class="fas fa-sign-in-alt me-2"></i>Login</button>
        </form>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" class="hide">
    <div class="overlay" id="overlay" onclick="toggleNav()"></div>
    
    <nav class="sidebar" id="sidebar">
        <h4><i class="fas fa-bug me-2"></i>A2Z IPM</h4>
        <div class="nav-item active" data-p="dash"><i class="fas fa-home"></i><span>Dashboard</span></div>
        <div class="nav-item staff-menu" data-p="entry"><i class="fas fa-edit"></i><span>Data Entry</span></div>
        <div class="nav-item" data-p="records"><i class="fas fa-list"></i><span>Records</span></div>
        <div class="nav-section admin-menu">Admin</div>
        <div class="nav-item admin-menu" data-p="staff"><i class="fas fa-users"></i><span>Staff</span></div>
        <div class="nav-item admin-menu" data-p="clients"><i class="fas fa-handshake"></i><span>Clients</span></div>
        <div class="nav-item admin-menu" data-p="projects"><i class="fas fa-building"></i><span>Projects</span></div>
        <div class="nav-section">Account</div>
        <div class="nav-item" data-p="settings"><i class="fas fa-cog"></i><span>Settings</span></div>
        <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
    </nav>
    
    <div class="main" id="main">
        <div class="topbar no-print">
            <button class="toggle-btn" onclick="toggleNav()"><i class="fas fa-bars"></i></button>
            <div class="d-flex align-items-center gap-2">
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold" id="userName"></div>
                    <small class="text-muted" id="userRole"></small>
                </div>
                <div class="user-avatar" id="userAv">A</div>
            </div>
        </div>
        
        <div class="content">
            <!-- Dashboard -->
            <div id="pg-dash" class="page">
                <h5 class="mb-3">Dashboard</h5>
                <div class="stat-grid" id="stats"></div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-clock me-2"></i>Recent Activity</div>
                    <div class="card-body" id="activity"><p class="text-muted mb-0">No activity</p></div>
                </div>
            </div>
            
            <!-- Data Entry -->
            <div id="pg-entry" class="page hide">
                <h5 class="mb-3">Data Entry</h5>
                <div class="card mb-3">
                    <div class="card-body">
                        <label class="form-label">Select Project</label>
                        <select id="selProject" class="form-select"></select>
                    </div>
                </div>
                <div class="form-grid" id="formCards"></div>
            </div>
            
            <!-- Records -->
            <div id="pg-records" class="page hide">
                <h5 class="mb-3" id="recTitle">Records</h5>
                <div class="card mb-3 no-print">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="date" id="fFrom" class="form-control"></div>
                            <div class="col-md-3"><input type="date" id="fTo" class="form-control"></div>
                            <div class="col-md-3"><select id="fType" class="form-select"><option value="">All Types</option></select></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="loadRecords()"><i class="fas fa-search"></i> Filter</button></div>
                        </div>
                    </div>
                </div>
                <div class="card no-print">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Date</th><th>Project</th><th>Type</th><th>By</th><th>Actions</th></tr></thead>
                                <tbody id="recBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Management -->
            <div id="pg-staff" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Staff Management</h5>
                    <button class="btn btn-primary btn-sm" onclick="openStaffModal()"><i class="fas fa-plus"></i> Add Staff</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Emp ID</th><th>Name</th><th>Username</th><th>Projects</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="staffBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Client Management -->
            <div id="pg-clients" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Client Accounts</h5>
                    <button class="btn btn-primary btn-sm" onclick="openClientModal()"><i class="fas fa-plus"></i> Add Client</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Username</th><th>Client Name</th><th>Project</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="clientBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Projects -->
            <div id="pg-projects" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Projects</h5>
                    <button class="btn btn-primary btn-sm" onclick="openProjModal()"><i class="fas fa-plus"></i> Add Project</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Code</th><th>Name</th><th>Client</th><th>GPS Auth</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="projBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div id="pg-settings" class="page hide">
                <h5 class="mb-3">Settings</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-user me-2"></i>My Profile</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" id="setName" class="form-control">
                                </div>
                                <div class="mb-3" id="pwdSetDiv">
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="setPass" class="form-control" placeholder="Leave empty to keep current">
                                </div>
                                <div id="pwdMsg" class="alert alert-warning small mb-3 hide">Contact Admin to change password.</div>
                                <button class="btn btn-primary" onclick="saveProfile()"><i class="fas fa-save me-1"></i>Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 admin-menu">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-database me-2"></i>Data</div>
                            <div class="card-body">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="exportData()"><i class="fas fa-download me-1"></i>Export All Data</button>
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="syncNow()"><i class="fas fa-sync me-1"></i>Sync Now</button>
                                <button class="btn btn-outline-danger w-100" onclick="clearData()"><i class="fas fa-trash me-1"></i>Clear All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Staff Modal -->
<div class="modal fade" id="staffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Employee ID <span class="text-danger">*</span></label>
                        <input type="text" id="sEmpId" class="form-control" required placeholder="e.g., PCO001">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" id="sName" class="form-control" required placeholder="e.g., Ali Khan">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" id="sUser" class="form-control" required placeholder="e.g., ali">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="text" id="sPwd" class="form-control" placeholder="Enter password">
                        <small class="text-muted" id="sPwdHint">Required for new staff</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input type="text" id="sPhone" class="form-control" placeholder="e.g., 0300-1234567">
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Projects</label>
                    <div id="sProjList" class="border rounded p-2" style="max-height:150px;overflow-y:auto"></div>
                    <small class="text-muted">Select projects this staff can access</small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="sActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()"><i class="fas fa-save me-1"></i>Save Staff</button>
            </div>
        </div>
    </div>
</div>

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="clientModalTitle">Add Client Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cId">
                <div class="mb-3">
                    <label class="form-label">Client/Company Name <span class="text-danger">*</span></label>
                    <input type="text" id="cName" class="form-control" required placeholder="e.g., MBC Pvt Ltd">
                </div>
                <div class="mb-3">
                    <label class="form-label">Username <span class="text-danger">*</span></label>
                    <input type="text" id="cUser" class="form-control" required placeholder="e.g., mbc">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <input type="text" id="cPwd" class="form-control" placeholder="Enter password">
                    <small class="text-muted" id="cPwdHint">Required for new client</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Project <span class="text-danger">*</span></label>
                    <select id="cProj" class="form-select" required>
                        <option value="">-- Select Project --</option>
                    </select>
                    <small class="text-muted">Client can only view this project's data</small>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="cActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveClient()"><i class="fas fa-save me-1"></i>Save Client</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal fade" id="projModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="projModalTitle">Add Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Code <span class="text-danger">*</span></label>
                        <input type="text" id="pCode" class="form-control" required placeholder="e.g., PRJ001">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Name <span class="text-danger">*</span></label>
                        <input type="text" id="pName" class="form-control" required placeholder="e.g., ABC Factory">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client Name <span class="text-danger">*</span></label>
                        <input type="text" id="pClient" class="form-control" required placeholder="e.g., ABC Pvt Ltd">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" id="pContact" class="form-control" placeholder="e.g., Mr. Ahmed">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <input type="text" id="pAddr" class="form-control" placeholder="e.g., Industrial Area, Lahore">
                </div>
                <div class="card bg-light mb-3">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-map-marker-alt me-1"></i>GPS Location</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="pGpsEnabled">
                            <label class="form-check-label" for="pGpsEnabled">Enable Auth</label>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label small">Latitude</label>
                                <input type="number" step="any" id="pLat" class="form-control form-control-sm" placeholder="31.5204">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Longitude</label>
                                <input type="number" step="any" id="pLng" class="form-control form-control-sm" placeholder="74.3587">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Radius (m)</label>
                                <input type="number" id="pRad" class="form-control form-control-sm" value="50" min="10" max="500">
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="getMyLoc()">
                            <i class="fas fa-crosshairs me-1"></i>Use My Location
                        </button>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="pActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProj()"><i class="fas fa-save me-1"></i>Save Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Form Entry Modal -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="formTitle">Form</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="formBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveForm()"><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal fade" id="attModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Attendance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="gpsSection">
                    <div id="locStatus" class="loc-status wait">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <div><strong>Checking location...</strong><br><small>Please allow access</small></div>
                    </div>
                    <div id="attMap"></div>
                </div>
                <div id="attForm" class="hide">
                    <div class="alert alert-info py-2" id="gpsSkipMsg" style="display:none"><i class="fas fa-info-circle"></i> GPS Authentication is disabled for this project.</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" id="aDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time In</label>
                            <input type="time" id="aIn" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time Out</label>
                            <input type="time" id="aOut" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Work Done</label>
                        <textarea id="aWork" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea id="aRem" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <input type="hidden" id="aLat">
                <input type="hidden" id="aLng">
                <input type="hidden" id="aDist">
                <input type="hidden" id="aVerified">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary hide" id="retryBtn" onclick="checkLoc()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="attSaveBtn" onclick="saveAtt()" disabled>
                    <i class="fas fa-save me-1"></i>Save Attendance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">View Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="viewBody"></div>
            <div class="modal-footer no-print">
                <button class="btn btn-outline-primary" onclick="window.print()"><i class="fas fa-print me-1"></i>Print</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ============== FIREBASE CONFIG ==============
firebase.initializeApp({
    apiKey: "AIzaSyCMBoABKBWTOx1B6zEBCk7QCeTKogUYgxQ",
    authDomain: "a2z-ipm.firebaseapp.com",
    databaseURL: "https://a2z-ipm-default-rtdb.firebaseio.com",
    projectId: "a2z-ipm",
    storageBucket: "a2z-ipm.firebasestorage.app",
    messagingSenderId: "37433212653",
    appId: "1:37433212653:web:e58af93855931236d456e4"
});

const firebaseDB = firebase.database();
let useFirebase = true; // Set to true to use Firebase as primary database

// ============== CONFIG ==============
const DB_NAME = 'A2Z_IPM_v7';
const COMPANY = {
    name: 'A2Z Industrial Solutions',
    addr: '30-F, J-1 Market, Wapda Town, Lahore',
    phone: '0307-0430056',
    email: 'info@a2zidsolutions.com'
};

let db = null;
let currentUser = null;
let attMap = null;
let curProj = null;
let curForm = null;
let rowCount = 0;

// ============== HELPERS ==============
const $ = id => document.getElementById(id);
const toast = (msg, type = 'success') => {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle text-success' : 'exclamation-circle text-danger'}"></i><span>${msg}</span>`;
    $('toasts').appendChild(t);
    setTimeout(() => t.remove(), 3000);
};

const showSync = (status) => {
    const el = $('syncIndicator');
    el.className = 'sync-indicator ' + status;
    if(status === 'syncing') el.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Syncing...';
    else if(status === 'synced') el.innerHTML = '<i class="fas fa-check me-1"></i>Synced!';
    else if(status === 'error') el.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Sync Error';
    if(status === 'synced') setTimeout(() => el.className = 'sync-indicator', 2000);
};

// ============== FIREBASE DATABASE FUNCTIONS ==============
const fbAdd = (store, data) => new Promise((res, rej) => {
    const newRef = firebaseDB.ref(store).push();
    const newData = { ...data, id: newRef.key, createdAt: Date.now() };
    newRef.set(newData)
        .then(() => res(newRef.key))
        .catch(rej);
});

const fbPut = (store, data) => new Promise((res, rej) => {
    if(!data.id) return rej(new Error('No ID provided'));
    firebaseDB.ref(store + '/' + data.id).update({ ...data, updatedAt: Date.now() })
        .then(() => res(data.id))
        .catch(rej);
});

const fbDel = (store, id) => new Promise((res, rej) => {
    firebaseDB.ref(store + '/' + id).remove()
        .then(() => res())
        .catch(rej);
});

const fbAll = store => new Promise((res, rej) => {
    firebaseDB.ref(store).once('value')
        .then(snapshot => {
            const data = [];
            snapshot.forEach(child => {
                data.push({ ...child.val(), id: child.key });
            });
            res(data);
        })
        .catch(rej);
});

const fbGet = (store, id) => new Promise((res, rej) => {
    firebaseDB.ref(store + '/' + id).once('value')
        .then(snapshot => res(snapshot.val()))
        .catch(rej);
});

// ============== DATABASE WRAPPER (Uses Firebase) ==============
const dbAdd = async (store, data) => {
    showSync('syncing');
    try {
        const result = await fbAdd(store, data);
        showSync('synced');
        return result;
    } catch(e) {
        showSync('error');
        throw e;
    }
};

const dbPut = async (store, data) => {
    showSync('syncing');
    try {
        const result = await fbPut(store, data);
        showSync('synced');
        return result;
    } catch(e) {
        showSync('error');
        throw e;
    }
};

const dbDel = async (store, id) => {
    showSync('syncing');
    try {
        await fbDel(store, id);
        showSync('synced');
    } catch(e) {
        showSync('error');
        throw e;
    }
};

const dbAll = async store => {
    try {
        return await fbAll(store);
    } catch(e) {
        console.error('Firebase read error:', e);
        return [];
    }
};

const dbGet = async (store, id) => {
    try {
        return await fbGet(store, id);
    } catch(e) {
        console.error('Firebase get error:', e);
        return null;
    }
};

// ============== SYNC FUNCTION ==============
async function syncNow() {
    showSync('syncing');
    toast('Syncing data...');
    try {
        // Refresh current page data
        if(currentUser) {
            loadDash();
            loadProjectsDropdown();
        }
        showSync('synced');
        toast('Data synced successfully!');
    } catch(e) {
        showSync('error');
        toast('Sync error: ' + e.message, 'error');
    }
}

// ============== INIT ==============
async function init() {
    try {
        const users = await dbAll('users');
        
        // Create default admin if no users
        if (users.length === 0) {
            await dbAdd('users', {
                empId: 'ADM001',
                name: 'Administrator',
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                projects: [],
                active: true
            });
            await dbAdd('projects', {
                code: 'PRJ001',
                name: 'Demo Project',
                client: 'Demo Client',
                contact: 'Mr. Demo',
                address: 'Lahore',
                lat: 31.5204,
                lng: 74.3587,
                radius: 50,
                gpsEnabled: true,
                active: true
            });
            console.log('âœ… Default admin and project created');
        }
        
        // Check session
        const session = localStorage.getItem('a2z_session');
        if (session) {
            const s = JSON.parse(session);
            const allUsers = await dbAll('users');
            const u = allUsers.find(user => user.id === s.id);
            if (u && u.active) {
                currentUser = u;
                showApp();
                return;
            }
        }
        $('loginPage').classList.remove('hide');
    } catch (e) {
        console.error('Init error:', e);
        alert('Error connecting to database. Please check your internet connection.');
    }
}

// ============== AUTH ==============
$('loginForm').onsubmit = async e => {
    e.preventDefault();
    const username = $('uname').value.trim().toLowerCase();
    const password = $('pwd').value;
    
    $('loginBtn').disabled = true;
    $('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
    
    try {
        const users = await dbAll('users');
        const user = users.find(u => 
            u.username && u.username.toLowerCase() === username && 
            u.password === password && u.active === true
        );
        
        if (user) {
            currentUser = user;
            localStorage.setItem('a2z_session', JSON.stringify({ id: user.id }));
            $('loginErr').classList.add('hide');
            showApp();
            toast('Welcome, ' + user.name);
        } else {
            $('loginErr').classList.remove('hide');
        }
    } catch (e) {
        alert('Login error: ' + e.message);
    }
    
    $('loginBtn').disabled = false;
    $('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Login';
};

function logout() {
    currentUser = null;
    localStorage.removeItem('a2z_session');
    location.reload();
}

function togglePwd() {
    const p = $('pwd'), i = $('pwdIcon');
    if (p.type === 'password') {
        p.type = 'text';
        i.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        p.type = 'password';
        i.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

// ============== UI ==============
function showApp() {
    $('loginPage').classList.add('hide');
    $('app').classList.remove('hide');
    $('userName').textContent = currentUser.name;
    $('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role === 'staff' ? 'PCO/Staff' : 'Client';
    $('userAv').textContent = currentUser.name[0].toUpperCase();
    
    const isAdmin = currentUser.role === 'admin';
    const isClient = currentUser.role === 'client';
    
    document.querySelectorAll('.admin-menu').forEach(el => el.classList.toggle('hide', !isAdmin));
    document.querySelectorAll('.staff-menu').forEach(el => el.classList.toggle('hide', isClient));
    
    $('recTitle').textContent = isClient ? 'Project Records' : 'Records';
    
    loadDash();
    loadProjectsDropdown();
}

function toggleNav() {
    const s = $('sidebar'), o = $('overlay'), m = $('main');
    if (window.innerWidth < 769) {
        s.classList.toggle('open');
        o.classList.toggle('show');
    } else {
        s.classList.toggle('closed');
        m.classList.toggle('full');
    }
}

document.querySelectorAll('.nav-item[data-p]').forEach(n => {
    n.onclick = function() {
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.add('hide'));
        $('pg-' + this.dataset.p).classList.remove('hide');
        
        const page = this.dataset.p;
        if (page === 'records') loadRecords();
        if (page === 'staff') loadStaff();
        if (page === 'clients') loadClients();
        if (page === 'projects') loadProjects();
        if (page === 'settings') loadSettings();
        
        if (window.innerWidth < 769) toggleNav();
    };
});

// ============== DASHBOARD ==============
async function loadDash() {
    const prj = await dbAll('projects');
    const rec = await dbAll('records');
    const users = await dbAll('users');
    const today = new Date().toISOString().split('T')[0];
    
    let myRec = rec;
    if (currentUser.role === 'staff') {
        myRec = rec.filter(r => r.userId === currentUser.id);
    } else if (currentUser.role === 'client') {
        myRec = rec.filter(r => r.projectId === currentUser.projectId);
    }
    
    let stats = '';
    if (currentUser.role === 'admin') {
        stats = `
            <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-building"></i></div><div class="stat-info"><h3>${prj.filter(p => p.active).length}</h3><p>Projects</p></div></div>
            <div class="stat-card"><div class="stat-icon green"><i class="fas fa-users"></i></div><div class="stat-info"><h3>${users.filter(u => u.role === 'staff' && u.active).length}</h3><p>Staff</p></div></div>
            <div class="stat-card"><div class="stat-icon orange"><i class="fas fa-clipboard"></i></div><div class="stat-info"><h3>${rec.filter(r => r.date === today).length}</h3><p>Today</p></div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${rec.length}</h3><p>Total</p></div></div>
        `;
    } else {
        stats = `
            <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-clipboard"></i></div><div class="stat-info"><h3>${myRec.filter(r => r.date === today).length}</h3><p>Today</p></div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${myRec.length}</h3><p>Total</p></div></div>
        `;
    }
    $('stats').innerHTML = stats;
    
    const recent = myRec.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);
    $('activity').innerHTML = recent.length ? recent.map(r => {
        const p = prj.find(x => x.id === r.projectId);
        return `<div class="d-flex gap-2 border-bottom py-2">
            <i class="fas fa-clipboard-check text-primary"></i>
            <div><strong>${formName(r.formType)}</strong> - ${p?.name || '-'}<br>
            <small class="text-muted">${formatDateTime(r.createdAt)}</small></div>
        </div>`;
    }).join('') : '<p class="text-muted mb-0">No activity yet</p>';
}

// ============== PROJECTS ==============
async function loadProjectsDropdown() {
    const prj = await dbAll('projects');
    let list = prj.filter(p => p.active);
    
    if (currentUser.role === 'staff') {
        const assigned = currentUser.projects || [];
        list = list.filter(p => assigned.includes(p.id));
    } else if (currentUser.role === 'client') {
        list = list.filter(p => p.id === currentUser.projectId);
    }
    
    $('selProject').innerHTML = '<option value="">-- Select Project --</option>' + 
        list.map(p => `<option value="${p.id}">${p.code} - ${p.name}</option>`).join('');
    
    const forms = [
        { t: 'attendance', i: 'clipboard-user', n: 'Attendance', gps: true },
        { t: 'insecticide', i: 'spray-can', n: 'Insecticide' },
        { t: 'gluebox', i: 'box-open', n: 'Glue Box' },
        { t: 'efk', i: 'lightbulb', n: 'EFK' },
        { t: 'lizard', i: 'dragon', n: 'Lizard' },
        { t: 'cat', i: 'cat', n: 'Cat' },
        { t: 'snake', i: 'staff-snake', n: 'Snake' },
        { t: 'checklist', i: 'tasks', n: 'Checklist' }
    ];
    
    $('formCards').innerHTML = forms.map(f => `
        <div class="form-card" onclick="openForm('${f.t}')">
            <i class="fas fa-${f.i}"></i>
            <h6>${f.n}</h6>
            ${f.gps ? '<small class="text-success"><i class="fas fa-map-marker-alt"></i> GPS</small>' : ''}
        </div>
    `).join('');
}

async function loadProjects() {
    if (currentUser.role !== 'admin') return;
    const prj = await dbAll('projects');
    $('projBody').innerHTML = prj.map(p => `
        <tr>
            <td><strong>${p.code}</strong></td>
            <td>${p.name}</td>
            <td>${p.client}</td>
            <td>${p.gpsEnabled ? '<span class="badge bg-success">ON</span>' : '<span class="badge bg-secondary">OFF</span>'}</td>
            <td><span class="badge ${p.active ? 'badge-ok' : 'badge-no'}">${p.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editProj('${p.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="delProj('${p.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="6" class="text-center text-muted">No projects</td></tr>';
}

function openProjModal() {
    $('projModalTitle').textContent = 'Add Project';
    $('pId').value = '';
    $('pCode').value = '';
    $('pName').value = '';
    $('pClient').value = '';
    $('pContact').value = '';
    $('pAddr').value = '';
    $('pLat').value = '';
    $('pLng').value = '';
    $('pRad').value = '50';
    $('pGpsEnabled').checked = false;
    $('pActive').checked = true;
    new bootstrap.Modal($('projModal')).show();
}

async function editProj(id) {
    const p = await dbGet('projects', id);
    $('projModalTitle').textContent = 'Edit Project';
    $('pId').value = p.id;
    $('pCode').value = p.code;
    $('pName').value = p.name;
    $('pClient').value = p.client;
    $('pContact').value = p.contact || '';
    $('pAddr').value = p.address || '';
    $('pLat').value = p.lat || '';
    $('pLng').value = p.lng || '';
    $('pRad').value = p.radius || 50;
    $('pGpsEnabled').checked = p.gpsEnabled || false;
    $('pActive').checked = p.active;
    new bootstrap.Modal($('projModal')).show();
}

async function saveProj() {
    const id = $('pId').value;
    const code = $('pCode').value.trim();
    const name = $('pName').value.trim();
    const client = $('pClient').value.trim();
    
    if (!code || !name || !client) {
        alert('Please fill required fields');
        return;
    }
    
    const data = {
        code, name, client,
        contact: $('pContact').value.trim(),
        address: $('pAddr').value.trim(),
        lat: parseFloat($('pLat').value) || null,
        lng: parseFloat($('pLng').value) || null,
        radius: parseInt($('pRad').value) || 50,
        gpsEnabled: $('pGpsEnabled').checked,
        active: $('pActive').checked
    };
    
    try {
        if (id) {
            data.id = id;
            await dbPut('projects', data);
            toast('Project updated');
        } else {
            await dbAdd('projects', data);
            toast('Project added');
        }
        bootstrap.Modal.getInstance($('projModal')).hide();
        loadProjects();
        loadProjectsDropdown();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function delProj(id) {
    if (confirm('Delete this project?')) {
        await dbDel('projects', id);
        toast('Project deleted');
        loadProjects();
        loadProjectsDropdown();
    }
}

function getMyLoc() {
    if (!navigator.geolocation) {
        alert('Geolocation not supported');
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            $('pLat').value = pos.coords.latitude.toFixed(6);
            $('pLng').value = pos.coords.longitude.toFixed(6);
            toast('Location captured');
        },
        err => alert('Error: ' + err.message),
        { enableHighAccuracy: true }
    );
}

// ============== STAFF MANAGEMENT ==============
async function loadStaff() {
    if (currentUser.role !== 'admin') return;
    const users = await dbAll('users');
    const prj = await dbAll('projects');
    const staff = users.filter(u => u.role === 'staff');
    
    $('staffBody').innerHTML = staff.map(s => {
        const projNames = (s.projects || []).map(pid => {
            const p = prj.find(x => x.id === pid);
            return p ? p.code : '';
        }).filter(Boolean).join(', ');
        
        return `<tr>
            <td>${s.empId || '-'}</td>
            <td><strong>${s.name}</strong></td>
            <td><code>${s.username}</code></td>
            <td>${projNames || '<span class="text-muted">None</span>'}</td>
            <td><span class="badge ${s.active ? 'badge-ok' : 'badge-no'}">${s.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editStaff('${s.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="delStaff('${s.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="6" class="text-center text-muted">No staff members</td></tr>';
}

async function openStaffModal() {
    $('staffModalTitle').textContent = 'Add Staff';
    $('sId').value = '';
    $('sEmpId').value = '';
    $('sName').value = '';
    $('sUser').value = '';
    $('sPwd').value = '';
    $('sPhone').value = '';
    $('sActive').checked = true;
    $('sPwdHint').textContent = 'Required for new staff';
    
    const prj = await dbAll('projects');
    $('sProjList').innerHTML = prj.filter(p => p.active).map(p => `
        <div class="form-check">
            <input class="form-check-input staff-proj" type="checkbox" value="${p.id}" id="sp_${p.id}">
            <label class="form-check-label" for="sp_${p.id}">${p.code} - ${p.name}</label>
        </div>
    `).join('') || '<p class="text-muted mb-0">No active projects</p>';
    
    new bootstrap.Modal($('staffModal')).show();
}

async function editStaff(id) {
    const s = await dbGet('users', id);
    const prj = await dbAll('projects');
    
    $('staffModalTitle').textContent = 'Edit Staff';
    $('sId').value = s.id;
    $('sEmpId').value = s.empId || '';
    $('sName').value = s.name;
    $('sUser').value = s.username;
    $('sPwd').value = '';
    $('sPhone').value = s.phone || '';
    $('sActive').checked = s.active;
    $('sPwdHint').textContent = 'Leave empty to keep current password';
    
    const assigned = s.projects || [];
    $('sProjList').innerHTML = prj.filter(p => p.active).map(p => `
        <div class="form-check">
            <input class="form-check-input staff-proj" type="checkbox" value="${p.id}" id="sp_${p.id}" ${assigned.includes(p.id) ? 'checked' : ''}>
            <label class="form-check-label" for="sp_${p.id}">${p.code} - ${p.name}</label>
        </div>
    `).join('') || '<p class="text-muted mb-0">No active projects</p>';
    
    new bootstrap.Modal($('staffModal')).show();
}

async function saveStaff() {
    const id = $('sId').value;
    const empId = $('sEmpId').value.trim();
    const name = $('sName').value.trim();
    const username = $('sUser').value.trim().toLowerCase();
    const password = $('sPwd').value;
    const phone = $('sPhone').value.trim();
    const active = $('sActive').checked;
    const projects = [...document.querySelectorAll('.staff-proj:checked')].map(c => c.value);
    
    if (!empId || !name || !username) return alert('Please fill required fields');
    if (!id && !password) return alert('Password required for new staff');
    
    const allUsers = await dbAll('users');
    const duplicate = allUsers.find(u => u.username.toLowerCase() === username && (!id || u.id !== id));
    if (duplicate) return alert('Username already exists');
    
    try {
        if (id) {
            const existing = await dbGet('users', id);
            await dbPut('users', {
                id, empId, name, username, password: password || existing.password, phone, role: 'staff', projects, active
            });
            toast('Staff updated');
        } else {
            await dbAdd('users', {
                empId, name, username, password, phone, role: 'staff', projects, active
            });
            toast('Staff added');
        }
        bootstrap.Modal.getInstance($('staffModal')).hide();
        loadStaff();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function delStaff(id) {
    if (confirm('Delete this staff member?')) {
        await dbDel('users', id);
        toast('Staff deleted');
        loadStaff();
    }
}

// ============== CLIENT MANAGEMENT ==============
async function loadClients() {
    if (currentUser.role !== 'admin') return;
    const users = await dbAll('users');
    const prj = await dbAll('projects');
    const clients = users.filter(u => u.role === 'client');
    
    $('clientBody').innerHTML = clients.map(c => {
        const p = prj.find(x => x.id === c.projectId);
        return `<tr>
            <td><code>${c.username}</code></td>
            <td><strong>${c.name}</strong></td>
            <td>${p?.name || '<span class="text-muted">Not assigned</span>'}</td>
            <td><span class="badge ${c.active ? 'badge-ok' : 'badge-no'}">${c.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editClient('${c.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="delClient('${c.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="5" class="text-center text-muted">No client accounts</td></tr>';
}

async function openClientModal() {
    $('clientModalTitle').textContent = 'Add Client Account';
    $('cId').value = '';
    $('cName').value = '';
    $('cUser').value = '';
    $('cPwd').value = '';
    $('cActive').checked = true;
    $('cPwdHint').textContent = 'Required for new client';
    const prj = await dbAll('projects');
    $('cProj').innerHTML = '<option value="">-- Select Project --</option>' + 
        prj.filter(p => p.active).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    new bootstrap.Modal($('clientModal')).show();
}

async function editClient(id) {
    const c = await dbGet('users', id);
    const prj = await dbAll('projects');
    $('clientModalTitle').textContent = 'Edit Client Account';
    $('cId').value = c.id;
    $('cName').value = c.name;
    $('cUser').value = c.username;
    $('cPwd').value = '';
    $('cActive').checked = c.active;
    $('cPwdHint').textContent = 'Leave empty to keep current password';
    $('cProj').innerHTML = '<option value="">-- Select Project --</option>' + 
        prj.filter(p => p.active).map(p => 
            `<option value="${p.id}" ${p.id === c.projectId ? 'selected' : ''}>${p.name}</option>`
        ).join('');
    new bootstrap.Modal($('clientModal')).show();
}

async function saveClient() {
    const id = $('cId').value;
    const name = $('cName').value.trim();
    const username = $('cUser').value.trim().toLowerCase();
    const password = $('cPwd').value;
    const projectId = $('cProj').value;
    const active = $('cActive').checked;
    
    if (!name || !username || !projectId) return alert('Fill required fields');
    if (!id && !password) return alert('Password required');
    
    const allUsers = await dbAll('users');
    const duplicate = allUsers.find(u => u.username.toLowerCase() === username && (!id || u.id !== id));
    if (duplicate) return alert('Username exists');
    
    try {
        if (id) {
            const existing = await dbGet('users', id);
            await dbPut('users', { id, name, username, password: password || existing.password, role: 'client', projectId, active });
            toast('Client updated');
        } else {
            await dbAdd('users', { name, username, password, role: 'client', projectId, active });
            toast('Client added');
        }
        bootstrap.Modal.getInstance($('clientModal')).hide();
        loadClients();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function delClient(id) {
    if (confirm('Delete client?')) {
        await dbDel('users', id);
        toast('Client deleted');
        loadClients();
    }
}

// ============== SETTINGS ==============
async function loadSettings() {
    $('setName').value = currentUser.name;
    $('setPass').value = '';
    
    if (currentUser.role === 'staff') {
        $('pwdSetDiv').classList.add('hide');
        $('pwdMsg').classList.remove('hide');
    } else {
        $('pwdSetDiv').classList.remove('hide');
        $('pwdMsg').classList.add('hide');
    }
}

async function saveProfile() {
    const name = $('setName').value.trim();
    const pass = $('setPass').value;
    
    if (!name) return alert('Name required');
    
    currentUser.name = name;
    if (currentUser.role !== 'staff' && pass) {
        currentUser.password = pass;
    }
    
    await dbPut('users', currentUser);
    $('userName').textContent = name;
    toast('Profile updated');
}

async function exportData() {
    const data = {
        users: await dbAll('users'),
        projects: await dbAll('projects'),
        records: await dbAll('records'),
        exportedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'a2z_backup.json';
    a.click();
}

function clearData() {
    if (confirm('DELETE ALL DATA? This cannot be undone!')) {
        firebaseDB.ref('/').remove().then(() => {
            localStorage.clear();
            location.reload();
        });
    }
}

// ============== FORMS (Abbreviated for length - same logic as before) ==============
async function openForm(type) {
    const pid = $('selProject').value;
    if (!pid) return alert('Select a project first');
    curForm = type;
    if (type === 'attendance') { openAttModal(); return; }
    $('formTitle').textContent = formName(type);
    $('formBody').innerHTML = genForm(type);
    rowCount = 0;
    new bootstrap.Modal($('formModal')).show();
}

function formName(t) {
    const names = { attendance: 'Attendance', insecticide: 'Insecticide Log', gluebox: 'Glue Box', efk: 'EFK Monitoring', lizard: 'Lizard Trapping', cat: 'Cat Trapping', snake: 'Snake Box', checklist: 'IPM Checklist' };
    return names[t] || t;
}

function genForm(t) {
    const d = new Date().toISOString().split('T')[0];
    const tm = new Date().toTimeString().slice(0, 5);
    return `<div class="row g-2 mb-3"><div class="col-md-6"><label class="form-label">Date</label><input type="date" id="fDate" class="form-control" value="${d}"></div><div class="col-md-6"><label class="form-label">Time</label><input type="time" id="fTime" class="form-control" value="${tm}"></div></div><div class="mb-3"><label class="form-label">Remarks</label><textarea id="fRem" class="form-control" rows="2"></textarea></div>`;
}

async function saveForm() {
    const pid = $('selProject').value;
    const date = $('fDate')?.value;
    if (!date) return alert('Enter date');
    
    const data = {
        formType: curForm, projectId: pid, userId: currentUser.id, date: date, status: 'submitted',
        time: $('fTime')?.value, remarks: $('fRem')?.value
    };
    
    try {
        await dbAdd('records', data);
        bootstrap.Modal.getInstance($('formModal')).hide();
        toast('Record saved!');
        loadDash();
    } catch (e) { alert('Error: ' + e.message); }
}

// ============== ATTENDANCE ==============
async function openAttModal() {
    curProj = await dbGet('projects', $('selProject').value);
    const gpsEnabled = curProj.gpsEnabled !== false;
    const d = new Date().toISOString().split('T')[0];
    const tm = new Date().toTimeString().slice(0, 5);
    
    $('aDate').value = d; $('aIn').value = tm; $('aOut').value = ''; $('aWork').value = ''; $('aRem').value = ''; $('aVerified').value = 'false';
    new bootstrap.Modal($('attModal')).show();
    
    if (gpsEnabled && curProj?.lat && curProj?.lng) {
        $('gpsSection').classList.remove('hide'); $('gpsSkipMsg').style.display = 'none';
        $('attForm').classList.add('hide'); $('attSaveBtn').disabled = true; $('retryBtn').classList.add('hide');
        $('locStatus').className = 'loc-status wait';
        $('locStatus').innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i><div><strong>Checking location...</strong></div>';
        setTimeout(() => { if (attMap) attMap.remove(); attMap = L.map('attMap').setView([curProj.lat, curProj.lng], 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(attMap); L.marker([curProj.lat, curProj.lng]).addTo(attMap); L.circle([curProj.lat, curProj.lng], { radius: curProj.radius || 50, color: '#004080', fillOpacity: 0.1 }).addTo(attMap); checkLoc(); }, 500);
    } else {
        $('gpsSection').classList.add('hide'); $('gpsSkipMsg').style.display = 'block';
        $('attForm').classList.remove('hide'); $('attSaveBtn').disabled = false;
        $('aVerified').value = 'skipped'; $('aLat').value = 0; $('aLng').value = 0; $('aDist').value = 0;
    }
}

function checkLoc() {
    $('retryBtn').classList.add('hide');
    if (!navigator.geolocation) return locErr('Geolocation not supported');
    $('locStatus').className = 'loc-status wait';
    $('locStatus').innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i><div><strong>Getting location...</strong></div>';
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        const dist = getDist(lat, lng, curProj.lat, curProj.lng);
        const radius = curProj.radius || 50;
        $('aLat').value = lat; $('aLng').value = lng; $('aDist').value = Math.round(dist);
        L.marker([lat, lng]).addTo(attMap); attMap.fitBounds([[lat, lng], [curProj.lat, curProj.lng]], { padding: [30, 30] });
        if (dist <= radius) {
            $('locStatus').className = 'loc-status ok';
            $('locStatus').innerHTML = `<i class="fas fa-check-circle text-success"></i><div><strong>Location Verified!</strong><br><small>${Math.round(dist)}m from site</small></div>`;
            $('aVerified').value = 'true'; $('attSaveBtn').disabled = false; $('attForm').classList.remove('hide');
        } else {
            $('locStatus').className = 'loc-status no';
            $('locStatus').innerHTML = `<i class="fas fa-times-circle text-danger"></i><div><strong>Too Far!</strong><br><small>${Math.round(dist)}m away</small></div>`;
            $('aVerified').value = 'false'; $('attSaveBtn').disabled = true; $('retryBtn').classList.remove('hide');
        }
    }, err => locErr(err.message), { enableHighAccuracy: true, timeout: 10000 });
}

function locErr(msg) { $('locStatus').className = 'loc-status no'; $('locStatus').innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i><div><strong>Error</strong><br><small>${msg}</small></div>`; $('retryBtn').classList.remove('hide'); }
function getDist(lat1, lon1, lat2, lon2) { const R = 6371000; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); }

async function saveAtt() {
    const data = { formType: 'attendance', projectId: curProj.id, userId: currentUser.id, date: $('aDate').value, timeIn: $('aIn').value, timeOut: $('aOut').value, work: $('aWork').value, remarks: $('aRem').value, location: { lat: parseFloat($('aLat').value), lng: parseFloat($('aLng').value), dist: parseInt($('aDist').value), verified: $('aVerified').value === 'true', skipped: $('aVerified').value === 'skipped' }, status: 'submitted' };
    try { await dbAdd('records', data); bootstrap.Modal.getInstance($('attModal')).hide(); toast('Attendance saved!'); loadDash(); } catch (e) { alert('Error: ' + e.message); }
}

// ============== RECORDS ==============
async function loadRecords() {
    const rec = await dbAll('records');
    const prj = await dbAll('projects');
    const users = await dbAll('users');
    
    let list = rec;
    if (currentUser.role === 'staff') list = rec.filter(r => r.userId === currentUser.id);
    else if (currentUser.role === 'client') list = rec.filter(r => r.projectId === currentUser.projectId);
    
    const from = $('fFrom').value, to = $('fTo').value, type = $('fType').value;
    if (from) list = list.filter(r => r.date >= from);
    if (to) list = list.filter(r => r.date <= to);
    if (type) list = list.filter(r => r.formType === type);
    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    
    const types = [...new Set(rec.map(r => r.formType))];
    $('fType').innerHTML = '<option value="">All Types</option>' + types.map(t => `<option value="${t}">${formName(t)}</option>`).join('');
    
    $('recBody').innerHTML = list.map(r => {
        const p = prj.find(x => x.id === r.projectId);
        const u = users.find(x => x.id === r.userId);
        return `<tr><td>${formatDate(r.date)}</td><td>${p?.name || '-'}</td><td><span class="badge bg-primary">${formName(r.formType)}</span></td><td>${u?.name || '-'}</td><td><button class="btn btn-sm btn-outline-primary" onclick="viewRec('${r.id}')"><i class="fas fa-eye"></i></button>${currentUser.role === 'admin' ? `<button class="btn btn-sm btn-outline-danger" onclick="delRec('${r.id}')"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`;
    }).join('') || '<tr><td colspan="5" class="text-center text-muted">No records</td></tr>';
}

async function viewRec(id) {
    const r = await dbGet('records', id);
    const p = await dbGet('projects', r.projectId);
    const u = await dbGet('users', r.userId);
    $('viewBody').innerHTML = `<div class="report"><div class="report-head"><div><h3>${COMPANY.name}</h3></div></div><div class="report-body"><div class="info-grid"><div class="info-item"><label>Project</label><span>${p?.name || '-'}</span></div><div class="info-item"><label>Date</label><span>${formatDate(r.date)}</span></div><div class="info-item"><label>PCO</label><span>${u?.name || '-'}</span></div><div class="info-item"><label>Type</label><span>${formName(r.formType)}</span></div></div>${r.remarks ? `<div class="bg-warning bg-opacity-25 p-3 rounded"><strong>Remarks:</strong> ${r.remarks}</div>` : ''}</div></div>`;
    new bootstrap.Modal($('viewModal')).show();
}

async function delRec(id) { if (confirm('Delete record?')) { await dbDel('records', id); toast('Deleted'); loadRecords(); } }

function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('en-GB'); }
function formatDateTime(ts) { if (!ts) return '-'; return new Date(ts).toLocaleString('en-GB', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }); }

// ============== START ==============
init();
console.log('âœ… A2Z IPM System - Firebase Connected!');
</script>
</body>
</html>