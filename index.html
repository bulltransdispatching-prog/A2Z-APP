<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2Z IPM System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--p:#004080;--s:#002b55;--g:#28a745;--r:#dc3545}
        *{box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:#f5f5f5;margin:0}
        .hide{display:none!important}
        
        .login-wrap{min-height:100vh;background:linear-gradient(135deg,var(--p),var(--s));display:flex;align-items:center;justify-content:center;padding:20px}
        .login-box{background:#fff;border-radius:15px;padding:30px;width:100%;max-width:360px;box-shadow:0 10px 40px rgba(0,0,0,.3)}
        .login-box h2{color:var(--p);text-align:center;margin-bottom:5px;font-weight:700}
        .app-sub{text-align:center;color:#666;font-size:0.9rem;margin-bottom:25px;font-weight:500}
        
        .sidebar{position:fixed;left:0;top:0;width:250px;height:100vh;background:linear-gradient(180deg,var(--p),var(--s));color:#fff;z-index:100;overflow-y:auto;transition:transform .3s}
        .sidebar.closed{transform:translateX(-250px)}
        .sidebar h4{padding:20px;margin:0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.2rem}
        .nav-item{padding:12px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;border-left:3px solid transparent;transition:all .2s}
        .nav-item:hover,.nav-item.active{background:rgba(255,255,255,.1);border-left-color:#f0ad4e}
        .nav-item i{width:20px}
        .nav-section{padding:10px 20px;font-size:.7rem;text-transform:uppercase;opacity:.5;margin-top:10px}
        
        .main{margin-left:250px;min-height:100vh;transition:margin .3s}
        .main.full{margin-left:0}
        .topbar{background:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.05);position:sticky;top:0;z-index:50}
        .content{padding:20px}
        .toggle-btn{background:none;border:none;font-size:1.3rem;color:var(--p);cursor:pointer}
        
        .card{border:none;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:20px}
        .card-header{background:var(--p);color:#fff;padding:12px 15px;border-radius:12px 12px 0 0!important;font-weight:600}
        .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background:#fff;border-radius:12px;padding:20px;display:flex;align-items:center;gap:15px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .stat-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.3rem}
        .stat-icon.blue{background:linear-gradient(135deg,#667eea,#764ba2)}
        .stat-icon.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
        .stat-icon.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
        .stat-icon.purple{background:linear-gradient(135deg,#4facfe,#00f2fe)}
        .stat-info h3{margin:0;font-size:1.5rem;font-weight:700}
        .stat-info p{margin:0;color:#888;font-size:.85rem}
        
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
        .form-card{background:#fff;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;border:2px solid transparent}
        .form-card:hover{border-color:var(--p);transform:translateY(-3px);box-shadow:0 5px 20px rgba(0,0,0,.1)}
        .form-card i{font-size:2.5rem;color:var(--p);margin-bottom:10px}
        .form-card h6{margin:0;font-weight:600}
        
        .table{margin:0}
        .table th{background:#f8f9fa;font-weight:600;font-size:.85rem}
        .badge-ok{background:#d4edda;color:#155724}
        .badge-no{background:#f8d7da;color:#721c24}
        
        .loc-status{padding:15px;border-radius:10px;display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .loc-status.ok{background:#d4edda;border:2px solid var(--g)}
        .loc-status.no{background:#f8d7da;border:2px solid var(--r)}
        .loc-status.wait{background:#cce5ff;border:2px solid #007bff}
        .loc-status i{font-size:1.5rem}
        #attMap{height:250px;border-radius:10px;margin-bottom:15px}
        
        .report{background:#fff;max-width:800px;margin:0 auto}
        .report-head{background:var(--p);color:#fff;padding:20px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px}
        .report-head h3{margin:0;font-weight:700}
        .report-title{background:#f8f9fa;padding:12px 20px;border-bottom:3px solid var(--p)}
        .report-title h4{margin:0;color:var(--p);font-weight:700}
        .report-body{padding:20px}
        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid var(--p)}
        .info-item label{font-size:.7rem;text-transform:uppercase;color:#666}
        .info-item span{display:block;font-weight:500}
        .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
        .summary-box{background:#f8f9fa;padding:15px;text-align:center;border-radius:8px;border-left:3px solid var(--p)}
        .summary-box .num{font-size:1.8rem;font-weight:700;color:var(--p)}
        .summary-box .lbl{font-size:.75rem;color:#666}
        
        @media(max-width:768px){
            .sidebar{transform:translateX(-250px)}
            .sidebar.open{transform:translateX(0)}
            .main{margin-left:0}
            .summary-grid{grid-template-columns:repeat(2,1fr)}
            .info-grid{grid-template-columns:1fr}
        }
        
        @media print{
            .sidebar,.topbar,.no-print{display:none!important}
            .main{margin:0!important}
            .content{padding:0!important}
        }
        
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
        .overlay.show{display:block}
        .user-avatar{width:35px;height:35px;border-radius:50%;background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
        
        .toast-container{position:fixed;top:20px;right:20px;z-index:9999}
        .toast{background:#fff;border-radius:8px;padding:15px 20px;box-shadow:0 5px 20px rgba(0,0,0,.15);margin-bottom:10px;display:flex;align-items:center;gap:10px;animation:slideIn .3s}
        .toast.success{border-left:4px solid var(--g)}
        .toast.error{border-left:4px solid var(--r)}
        .toast.info{border-left:4px solid #17a2b8}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        .sync-status{position:fixed;bottom:20px;right:20px;padding:8px 15px;border-radius:20px;font-size:.8rem;display:flex;align-items:center;gap:8px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .sync-status.online{background:#d4edda;color:#155724}
        .sync-status.offline{background:#f8d7da;color:#721c24}
        .sync-status.syncing{background:#fff3cd;color:#856404}
        .sync-dot{width:8px;height:8px;border-radius:50%;animation:pulse 1.5s infinite}
        .online .sync-dot{background:#28a745}
        .offline .sync-dot{background:#dc3545}
        .syncing .sync-dot{background:#ffc107}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    </style>
</head>
<body>

<div class="toast-container" id="toasts"></div>

<div class="sync-status online" id="syncStatus">
    <div class="sync-dot"></div>
    <span id="syncText">Online</span>
</div>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-wrap">
    <div class="login-box">
        <h2><i class="fas fa-bug me-2"></i>A2Z IPM</h2>
        <div class="app-sub">Integrated Pest Management System</div>
        <div id="loginErr" class="alert alert-danger hide"></div>
        <div id="loginLoading" class="text-center py-3 hide">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2 mb-0">Loading...</p>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" id="uname" class="form-control" required autocomplete="username">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <div class="input-group">
                    <input type="password" id="pwd" class="form-control" required autocomplete="current-password">
                    <button type="button" class="btn btn-outline-secondary" onclick="togglePwd()"><i class="fas fa-eye" id="pwdIcon"></i></button>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginBtn"><i class="fas fa-sign-in-alt me-2"></i>Login</button>
        </form>
    </div>
</div>

<!-- MAIN APP -->
<div id="app" class="hide">
    <div class="overlay" id="overlay" onclick="toggleNav()"></div>
    
    <nav class="sidebar" id="sidebar">
        <h4><i class="fas fa-bug me-2"></i>A2Z IPM</h4>
        <div class="nav-item active" data-p="dash"><i class="fas fa-home"></i><span>Dashboard</span></div>
        <div class="nav-item staff-menu" data-p="entry"><i class="fas fa-edit"></i><span>Data Entry</span></div>
        <div class="nav-item" data-p="records"><i class="fas fa-list"></i><span>Records</span></div>
        <div class="nav-section admin-menu">Admin</div>
        <div class="nav-item admin-menu" data-p="staff"><i class="fas fa-users"></i><span>Staff</span></div>
        <div class="nav-item admin-menu" data-p="clients"><i class="fas fa-handshake"></i><span>Clients</span></div>
        <div class="nav-item admin-menu" data-p="projects"><i class="fas fa-building"></i><span>Projects</span></div>
        <div class="nav-section">Account</div>
        <div class="nav-item" data-p="settings"><i class="fas fa-cog"></i><span>Settings</span></div>
        <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
    </nav>
    
    <div class="main" id="main">
        <div class="topbar no-print">
            <button class="toggle-btn" onclick="toggleNav()"><i class="fas fa-bars"></i></button>
            <div class="d-flex align-items-center gap-2">
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold" id="userName"></div>
                    <small class="text-muted" id="userRole"></small>
                </div>
                <div class="user-avatar" id="userAv">A</div>
            </div>
        </div>
        
        <div class="content">
            <!-- Dashboard -->
            <div id="pg-dash" class="page">
                <h5 class="mb-3"><i class="fas fa-home me-2"></i>Dashboard</h5>
                <div class="stat-grid" id="stats"></div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-clock me-2"></i>Recent Activity</div>
                    <div class="card-body" id="activity"><p class="text-muted mb-0">No activity</p></div>
                </div>
            </div>
            
            <!-- Data Entry -->
            <div id="pg-entry" class="page hide">
                <h5 class="mb-3"><i class="fas fa-edit me-2"></i>Data Entry</h5>
                <div class="card mb-3">
                    <div class="card-body">
                        <label class="form-label fw-bold">Select Project</label>
                        <select id="selProject" class="form-select"></select>
                    </div>
                </div>
                <div class="form-grid" id="formCards"></div>
            </div>
            
            <!-- Records -->
            <div id="pg-records" class="page hide">
                <h5 class="mb-3" id="recTitle"><i class="fas fa-list me-2"></i>Records</h5>
                <div class="card mb-3 no-print">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="date" id="fFrom" class="form-control"></div>
                            <div class="col-md-3"><input type="date" id="fTo" class="form-control"></div>
                            <div class="col-md-3"><select id="fType" class="form-select"><option value="">All Types</option></select></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="loadRecords()"><i class="fas fa-search"></i> Filter</button></div>
                        </div>
                    </div>
                </div>
                <div class="card no-print">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Date</th><th>Project</th><th>Type</th><th>By</th><th>Actions</th></tr></thead>
                                <tbody id="recBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff -->
            <div id="pg-staff" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Staff Management</h5>
                    <button class="btn btn-primary btn-sm" onclick="openStaffModal()"><i class="fas fa-plus"></i> Add Staff</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Emp ID</th><th>Name</th><th>Username</th><th>Projects</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="staffBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Clients -->
            <div id="pg-clients" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-handshake me-2"></i>Client Accounts</h5>
                    <button class="btn btn-primary btn-sm" onclick="openClientModal()"><i class="fas fa-plus"></i> Add Client</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Username</th><th>Client Name</th><th>Project</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="clientBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Projects -->
            <div id="pg-projects" class="page hide">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-building me-2"></i>Projects</h5>
                    <button class="btn btn-primary btn-sm" onclick="openProjModal()"><i class="fas fa-plus"></i> Add Project</button>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Code</th><th>Name</th><th>Client</th><th>GPS</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="projBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div id="pg-settings" class="page hide">
                <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Settings</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-user me-2"></i>My Profile</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" id="setName" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="setPass" class="form-control" placeholder="Leave empty to keep current">
                                </div>
                                <button class="btn btn-primary" onclick="saveProfile()"><i class="fas fa-save me-1"></i>Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 admin-menu">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-database me-2"></i>Data Management</div>
                            <div class="card-body">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="syncNow()"><i class="fas fa-sync me-1"></i>Sync Now</button>
                                <button class="btn btn-outline-success w-100 mb-2" onclick="exportData()"><i class="fas fa-download me-1"></i>Export Data</button>
                                <button class="btn btn-outline-danger w-100" onclick="clearData()"><i class="fas fa-trash me-1"></i>Clear All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<!-- Staff Modal -->
<div class="modal fade" id="staffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="sFbKey">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Employee ID *</label>
                        <input type="text" id="sEmpId" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="sName" class="form-control" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Username *</label>
                        <input type="text" id="sUser" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Password *</label>
                        <input type="text" id="sPwd" class="form-control">
                        <small class="text-muted" id="sPwdHint">Required for new staff</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone</label>
                    <input type="text" id="sPhone" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Projects</label>
                    <div id="sProjList" class="border rounded p-2" style="max-height:150px;overflow-y:auto"></div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="sActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()"><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="clientModalTitle">Add Client</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cFbKey">
                <div class="mb-3">
                    <label class="form-label">Client Name *</label>
                    <input type="text" id="cName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Username *</label>
                    <input type="text" id="cUser" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password *</label>
                    <input type="text" id="cPwd" class="form-control">
                    <small class="text-muted" id="cPwdHint">Required for new client</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assigned Project *</label>
                    <select id="cProj" class="form-select" required></select>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="cActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveClient()"><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal fade" id="projModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="projModalTitle">Add Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pFbKey">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Code *</label>
                        <input type="text" id="pCode" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Project Name *</label>
                        <input type="text" id="pName" class="form-control" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Client Name *</label>
                        <input type="text" id="pClient" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" id="pContact" class="form-control">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <input type="text" id="pAddr" class="form-control">
                </div>
                <div class="card bg-light mb-3">
                    <div class="card-header py-2">
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" id="pGpsEnabled">
                            <label class="form-check-label" for="pGpsEnabled"><i class="fas fa-map-marker-alt me-1"></i>Enable GPS Authentication</label>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label small">Latitude</label>
                                <input type="number" step="any" id="pLat" class="form-control form-control-sm">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Longitude</label>
                                <input type="number" step="any" id="pLng" class="form-control form-control-sm">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Radius (m)</label>
                                <input type="number" id="pRad" class="form-control form-control-sm" value="50">
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="getMyLoc()"><i class="fas fa-crosshairs me-1"></i>Use My Location</button>
                    </div>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="pActive" checked>
                    <label class="form-check-label">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProj()"><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Form Modal -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="formTitle">Form</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="formBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveForm()"><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal fade" id="attModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Attendance</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="gpsSection">
                    <div id="locStatus" class="loc-status wait">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                        <div><strong>Checking location...</strong></div>
                    </div>
                    <div id="attMap"></div>
                </div>
                <div id="attForm" class="hide">
                    <div class="alert alert-info py-2" id="gpsSkipMsg" style="display:none"><i class="fas fa-info-circle"></i> GPS disabled for this project.</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" id="aDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time In</label>
                            <input type="time" id="aIn" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Time Out</label>
                            <input type="time" id="aOut" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Work Done</label>
                        <textarea id="aWork" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea id="aRem" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <input type="hidden" id="aLat"><input type="hidden" id="aLng"><input type="hidden" id="aDist"><input type="hidden" id="aVerified">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary hide" id="retryBtn" onclick="checkLoc()"><i class="fas fa-redo me-1"></i>Retry</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="attSaveBtn" onclick="saveAtt()" disabled><i class="fas fa-save me-1"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">View Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="viewBody"></div>
            <div class="modal-footer no-print">
                <button class="btn btn-outline-primary" onclick="window.print()"><i class="fas fa-print me-1"></i>Print</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ============== CONFIG ==============
const COMPANY = { name: 'A2Z Industrial Solutions', addr: '30-F, J-1 Market, Wapda Town, Lahore', phone: '0307-0430056' };

const firebaseConfig = {
    apiKey: "AIzaSyCMBoABKBWTOx1B6zEBCk7QCeTKogUYgxQ",
    authDomain: "a2z-ipm.firebaseapp.com",
    databaseURL: "https://a2z-ipm-default-rtdb.firebaseio.com",
    projectId: "a2z-ipm",
    storageBucket: "a2z-ipm.firebasestorage.app",
    messagingSenderId: "37433212653",
    appId: "1:37433212653:web:e58af93855931236d456e4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let attMap = null;
let curProj = null;
let curForm = null;
let rowCount = 0;
let currentPage = 'dash';
let isOnline = navigator.onLine;

// Cache
let usersCache = [];
let projectsCache = [];
let recordsCache = [];

// ============== HELPERS ==============
const $ = id => document.getElementById(id);
const toast = (msg, type = 'success') => {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'times-circle text-danger' : 'info-circle text-info'}"></i><span>${msg}</span>`;
    $('toasts').appendChild(t);
    setTimeout(() => t.remove(), 3000);
};

const updateSync = s => {
    $('syncStatus').className = 'sync-status ' + s;
    $('syncText').textContent = s === 'online' ? 'Online' : s === 'offline' ? 'Offline' : 'Syncing...';
};

window.addEventListener('online', () => { isOnline = true; updateSync('online'); });
window.addEventListener('offline', () => { isOnline = false; updateSync('offline'); });

// ============== FIREBASE REALTIME ==============
function setupListeners() {
    // Users
    db.ref('users').on('value', snap => {
        usersCache = [];
        snap.forEach(c => usersCache.push({ ...c.val(), fbKey: c.key }));
        console.log('Users synced:', usersCache.length);
        if (currentUser) refreshPage();
    });
    
    // Projects
    db.ref('projects').on('value', snap => {
        projectsCache = [];
        snap.forEach(c => projectsCache.push({ ...c.val(), fbKey: c.key }));
        console.log('Projects synced:', projectsCache.length);
        if (currentUser) refreshPage();
    });
    
    // Records
    db.ref('records').on('value', snap => {
        recordsCache = [];
        snap.forEach(c => recordsCache.push({ ...c.val(), fbKey: c.key }));
        console.log('Records synced:', recordsCache.length);
        if (currentUser) refreshPage();
    });
}

function refreshPage() {
    if (currentPage === 'dash') loadDash();
    if (currentPage === 'staff') loadStaff();
    if (currentPage === 'clients') loadClients();
    if (currentPage === 'projects') loadProjects();
    if (currentPage === 'records') loadRecords();
    if (currentPage === 'entry') loadProjectsDropdown();
}

// ============== ENSURE ADMIN ==============
async function ensureAdmin() {
    return new Promise(resolve => {
        db.ref('users').orderByChild('username').equalTo('admin').once('value', snap => {
            if (!snap.exists()) {
                console.log('Creating admin...');
                db.ref('users').push({
                    empId: 'ADM001',
                    name: 'Administrator',
                    username: 'admin',
                    password: 'admin123',
                    role: 'admin',
                    projects: [],
                    active: true,
                    createdAt: Date.now()
                }).then(() => {
                    console.log('Admin created');
                    resolve();
                });
            } else {
                resolve();
            }
        });
    });
}

// ============== INIT ==============
async function init() {
    updateSync(isOnline ? 'online' : 'offline');
    $('loginLoading').classList.remove('hide');
    $('loginForm').classList.add('hide');
    
    try {
        await ensureAdmin();
        setupListeners();
        
        // Wait for initial data
        await new Promise(r => setTimeout(r, 1500));
        
        // Check session
        const sess = localStorage.getItem('a2z_user');
        if (sess) {
            const u = usersCache.find(x => x.fbKey === sess && x.active);
            if (u) {
                currentUser = u;
                showApp();
                $('loginLoading').classList.add('hide');
                return;
            }
        }
        
        $('loginLoading').classList.add('hide');
        $('loginForm').classList.remove('hide');
    } catch (e) {
        console.error('Init error:', e);
        $('loginLoading').classList.add('hide');
        $('loginForm').classList.remove('hide');
    }
}

// ============== AUTH ==============
$('loginForm').onsubmit = async e => {
    e.preventDefault();
    const username = $('uname').value.trim().toLowerCase();
    const password = $('pwd').value;
    
    $('loginBtn').disabled = true;
    $('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
    $('loginErr').classList.add('hide');
    
    // Find user
    const user = usersCache.find(u => u.username?.toLowerCase() === username && u.password === password && u.active);
    
    if (user) {
        currentUser = user;
        localStorage.setItem('a2z_user', user.fbKey);
        showApp();
        toast('Welcome, ' + user.name);
    } else {
        $('loginErr').textContent = 'Invalid username or password';
        $('loginErr').classList.remove('hide');
    }
    
    $('loginBtn').disabled = false;
    $('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Login';
};

function logout() {
    currentUser = null;
    localStorage.removeItem('a2z_user');
    location.reload();
}

function togglePwd() {
    const p = $('pwd'), i = $('pwdIcon');
    p.type = p.type === 'password' ? 'text' : 'password';
    i.classList.toggle('fa-eye');
    i.classList.toggle('fa-eye-slash');
}

// ============== SHOW APP ==============
function showApp() {
    $('loginPage').classList.add('hide');
    $('app').classList.remove('hide');
    $('userName').textContent = currentUser.name;
    $('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role === 'staff' ? 'Staff' : 'Client';
    $('userAv').textContent = currentUser.name[0].toUpperCase();
    
    const isAdmin = currentUser.role === 'admin';
    const isClient = currentUser.role === 'client';
    
    document.querySelectorAll('.admin-menu').forEach(el => el.classList.toggle('hide', !isAdmin));
    document.querySelectorAll('.staff-menu').forEach(el => el.classList.toggle('hide', isClient));
    
    loadDash();
    loadProjectsDropdown();
}

function toggleNav() {
    const s = $('sidebar'), o = $('overlay'), m = $('main');
    if (window.innerWidth < 769) {
        s.classList.toggle('open');
        o.classList.toggle('show');
    } else {
        s.classList.toggle('closed');
        m.classList.toggle('full');
    }
}

document.querySelectorAll('.nav-item[data-p]').forEach(n => {
    n.onclick = function() {
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.add('hide'));
        $('pg-' + this.dataset.p).classList.remove('hide');
        currentPage = this.dataset.p;
        refreshPage();
        if (window.innerWidth < 769) toggleNav();
    };
});

// ============== DASHBOARD ==============
function loadDash() {
    const today = new Date().toISOString().split('T')[0];
    let myRec = recordsCache;
    
    if (currentUser.role === 'staff') {
        myRec = recordsCache.filter(r => r.userKey === currentUser.fbKey);
    } else if (currentUser.role === 'client') {
        myRec = recordsCache.filter(r => r.projectKey === currentUser.projectKey);
    }
    
    let stats = '';
    if (currentUser.role === 'admin') {
        stats = `
            <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-building"></i></div><div class="stat-info"><h3>${projectsCache.filter(p => p.active).length}</h3><p>Projects</p></div></div>
            <div class="stat-card"><div class="stat-icon green"><i class="fas fa-users"></i></div><div class="stat-info"><h3>${usersCache.filter(u => u.role === 'staff' && u.active).length}</h3><p>Staff</p></div></div>
            <div class="stat-card"><div class="stat-icon orange"><i class="fas fa-clipboard"></i></div><div class="stat-info"><h3>${recordsCache.filter(r => r.date === today).length}</h3><p>Today</p></div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${recordsCache.length}</h3><p>Total</p></div></div>
        `;
    } else {
        stats = `
            <div class="stat-card"><div class="stat-icon blue"><i class="fas fa-clipboard"></i></div><div class="stat-info"><h3>${myRec.filter(r => r.date === today).length}</h3><p>Today</p></div></div>
            <div class="stat-card"><div class="stat-icon purple"><i class="fas fa-file"></i></div><div class="stat-info"><h3>${myRec.length}</h3><p>Total</p></div></div>
        `;
    }
    $('stats').innerHTML = stats;
    
    const recent = myRec.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);
    $('activity').innerHTML = recent.length ? recent.map(r => {
        const p = projectsCache.find(x => x.fbKey === r.projectKey);
        return `<div class="d-flex gap-2 border-bottom py-2">
            <i class="fas fa-clipboard-check text-primary"></i>
            <div><strong>${formName(r.formType)}</strong> - ${p?.name || '-'}<br><small class="text-muted">${fmtDT(r.createdAt)}</small></div>
        </div>`;
    }).join('') : '<p class="text-muted mb-0">No activity</p>';
}

// ============== PROJECTS ==============
function loadProjectsDropdown() {
    let list = projectsCache.filter(p => p.active);
    
    if (currentUser.role === 'staff') {
        const assigned = currentUser.projects || [];
        list = list.filter(p => assigned.includes(p.fbKey));
    } else if (currentUser.role === 'client') {
        list = list.filter(p => p.fbKey === currentUser.projectKey);
    }
    
    $('selProject').innerHTML = '<option value="">-- Select Project --</option>' + list.map(p => `<option value="${p.fbKey}">${p.code} - ${p.name}</option>`).join('');
    
    const forms = [
        { t: 'attendance', i: 'clipboard-user', n: 'Attendance', gps: true },
        { t: 'insecticide', i: 'spray-can', n: 'Insecticide' },
        { t: 'gluebox', i: 'box-open', n: 'Glue Box' },
        { t: 'efk', i: 'lightbulb', n: 'EFK' },
        { t: 'lizard', i: 'dragon', n: 'Lizard' },
        { t: 'cat', i: 'cat', n: 'Cat' },
        { t: 'snake', i: 'staff-snake', n: 'Snake' },
        { t: 'checklist', i: 'tasks', n: 'Checklist' }
    ];
    
    $('formCards').innerHTML = forms.map(f => `
        <div class="form-card" onclick="openForm('${f.t}')">
            <i class="fas fa-${f.i}"></i>
            <h6>${f.n}</h6>
            ${f.gps ? '<small class="text-success"><i class="fas fa-map-marker-alt"></i> GPS</small>' : ''}
        </div>
    `).join('');
}

function loadProjects() {
    $('projBody').innerHTML = projectsCache.map(p => `
        <tr>
            <td><strong>${p.code}</strong></td>
            <td>${p.name}</td>
            <td>${p.client}</td>
            <td>${p.gpsEnabled ? '<span class="badge bg-success">ON</span>' : '<span class="badge bg-secondary">OFF</span>'}</td>
            <td><span class="badge ${p.active ? 'badge-ok' : 'badge-no'}">${p.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editProj('${p.fbKey}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="delProj('${p.fbKey}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="6" class="text-center text-muted">No projects</td></tr>';
}

function openProjModal() {
    $('projModalTitle').textContent = 'Add Project';
    $('pFbKey').value = '';
    $('pCode').value = '';
    $('pName').value = '';
    $('pClient').value = '';
    $('pContact').value = '';
    $('pAddr').value = '';
    $('pLat').value = '';
    $('pLng').value = '';
    $('pRad').value = '50';
    $('pGpsEnabled').checked = false;
    $('pActive').checked = true;
    new bootstrap.Modal($('projModal')).show();
}

function editProj(key) {
    const p = projectsCache.find(x => x.fbKey === key);
    if (!p) return;
    $('projModalTitle').textContent = 'Edit Project';
    $('pFbKey').value = p.fbKey;
    $('pCode').value = p.code;
    $('pName').value = p.name;
    $('pClient').value = p.client;
    $('pContact').value = p.contact || '';
    $('pAddr').value = p.address || '';
    $('pLat').value = p.lat || '';
    $('pLng').value = p.lng || '';
    $('pRad').value = p.radius || 50;
    $('pGpsEnabled').checked = p.gpsEnabled || false;
    $('pActive').checked = p.active;
    new bootstrap.Modal($('projModal')).show();
}

function saveProj() {
    const key = $('pFbKey').value;
    const data = {
        code: $('pCode').value.trim(),
        name: $('pName').value.trim(),
        client: $('pClient').value.trim(),
        contact: $('pContact').value.trim(),
        address: $('pAddr').value.trim(),
        lat: parseFloat($('pLat').value) || null,
        lng: parseFloat($('pLng').value) || null,
        radius: parseInt($('pRad').value) || 50,
        gpsEnabled: $('pGpsEnabled').checked,
        active: $('pActive').checked,
        updatedAt: Date.now()
    };
    
    if (!data.code || !data.name || !data.client) return alert('Fill required fields');
    
    if (key) {
        db.ref('projects/' + key).update(data);
        toast('Project updated');
    } else {
        data.createdAt = Date.now();
        db.ref('projects').push(data);
        toast('Project added');
    }
    bootstrap.Modal.getInstance($('projModal')).hide();
}

function delProj(key) {
    if (confirm('Delete this project?')) {
        db.ref('projects/' + key).remove();
        toast('Project deleted');
    }
}

function getMyLoc() {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(
        pos => {
            $('pLat').value = pos.coords.latitude.toFixed(6);
            $('pLng').value = pos.coords.longitude.toFixed(6);
            toast('Location captured');
        },
        err => alert('Error: ' + err.message),
        { enableHighAccuracy: true }
    );
}

// ============== STAFF ==============
function loadStaff() {
    const staff = usersCache.filter(u => u.role === 'staff');
    $('staffBody').innerHTML = staff.map(s => {
        const projNames = (s.projects || []).map(pk => projectsCache.find(p => p.fbKey === pk)?.code).filter(Boolean).join(', ');
        return `<tr>
            <td>${s.empId || '-'}</td>
            <td><strong>${s.name}</strong></td>
            <td><code>${s.username}</code></td>
            <td>${projNames || '<span class="text-muted">None</span>'}</td>
            <td><span class="badge ${s.active ? 'badge-ok' : 'badge-no'}">${s.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editStaff('${s.fbKey}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="delStaff('${s.fbKey}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="6" class="text-center text-muted">No staff</td></tr>';
}

function openStaffModal() {
    $('staffModalTitle').textContent = 'Add Staff';
    $('sFbKey').value = '';
    $('sEmpId').value = '';
    $('sName').value = '';
    $('sUser').value = '';
    $('sPwd').value = '';
    $('sPhone').value = '';
    $('sActive').checked = true;
    $('sPwdHint').textContent = 'Required for new staff';
    
    $('sProjList').innerHTML = projectsCache.filter(p => p.active).map(p => `
        <div class="form-check">
            <input class="form-check-input staff-proj" type="checkbox" value="${p.fbKey}" id="sp_${p.fbKey}">
            <label class="form-check-label" for="sp_${p.fbKey}">${p.code} - ${p.name}</label>
        </div>
    `).join('') || '<p class="text-muted mb-0">No projects</p>';
    
    new bootstrap.Modal($('staffModal')).show();
}

function editStaff(key) {
    const s = usersCache.find(x => x.fbKey === key);
    if (!s) return;
    
    $('staffModalTitle').textContent = 'Edit Staff';
    $('sFbKey').value = s.fbKey;
    $('sEmpId').value = s.empId || '';
    $('sName').value = s.name;
    $('sUser').value = s.username;
    $('sPwd').value = '';
    $('sPhone').value = s.phone || '';
    $('sActive').checked = s.active;
    $('sPwdHint').textContent = 'Leave empty to keep current';
    
    const assigned = s.projects || [];
    $('sProjList').innerHTML = projectsCache.filter(p => p.active).map(p => `
        <div class="form-check">
            <input class="form-check-input staff-proj" type="checkbox" value="${p.fbKey}" id="sp_${p.fbKey}" ${assigned.includes(p.fbKey) ? 'checked' : ''}>
            <label class="form-check-label" for="sp_${p.fbKey}">${p.code} - ${p.name}</label>
        </div>
    `).join('') || '<p class="text-muted mb-0">No projects</p>';
    
    new bootstrap.Modal($('staffModal')).show();
}

function saveStaff() {
    const key = $('sFbKey').value;
    const data = {
        empId: $('sEmpId').value.trim(),
        name: $('sName').value.trim(),
        username: $('sUser').value.trim().toLowerCase(),
        phone: $('sPhone').value.trim(),
        role: 'staff',
        projects: [...document.querySelectorAll('.staff-proj:checked')].map(c => c.value),
        active: $('sActive').checked,
        updatedAt: Date.now()
    };
    
    if (!data.empId || !data.name || !data.username) return alert('Fill required fields');
    
    const pwd = $('sPwd').value;
    if (!key && !pwd) return alert('Password required');
    if (pwd) data.password = pwd;
    
    // Check duplicate username
    const dup = usersCache.find(u => u.username === data.username && u.fbKey !== key);
    if (dup) return alert('Username exists');
    
    if (key) {
        db.ref('users/' + key).update(data);
        toast('Staff updated');
    } else {
        data.createdAt = Date.now();
        db.ref('users').push(data);
        toast('Staff added');
    }
    bootstrap.Modal.getInstance($('staffModal')).hide();
}

function delStaff(key) {
    if (confirm('Delete staff?')) {
        db.ref('users/' + key).remove();
        toast('Staff deleted');
    }
}

// ============== CLIENTS ==============
function loadClients() {
    const clients = usersCache.filter(u => u.role === 'client');
    $('clientBody').innerHTML = clients.map(c => {
        const p = projectsCache.find(x => x.fbKey === c.projectKey);
        return `<tr>
            <td><code>${c.username}</code></td>
            <td><strong>${c.name}</strong></td>
            <td>${p?.name || '-'}</td>
            <td><span class="badge ${c.active ? 'badge-ok' : 'badge-no'}">${c.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editClient('${c.fbKey}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="delClient('${c.fbKey}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="5" class="text-center text-muted">No clients</td></tr>';
}

function openClientModal() {
    $('clientModalTitle').textContent = 'Add Client';
    $('cFbKey').value = '';
    $('cName').value = '';
    $('cUser').value = '';
    $('cPwd').value = '';
    $('cActive').checked = true;
    $('cPwdHint').textContent = 'Required for new client';
    $('cProj').innerHTML = '<option value="">-- Select --</option>' + projectsCache.filter(p => p.active).map(p => `<option value="${p.fbKey}">${p.name}</option>`).join('');
    new bootstrap.Modal($('clientModal')).show();
}

function editClient(key) {
    const c = usersCache.find(x => x.fbKey === key);
    if (!c) return;
    $('clientModalTitle').textContent = 'Edit Client';
    $('cFbKey').value = c.fbKey;
    $('cName').value = c.name;
    $('cUser').value = c.username;
    $('cPwd').value = '';
    $('cActive').checked = c.active;
    $('cPwdHint').textContent = 'Leave empty to keep current';
    $('cProj').innerHTML = '<option value="">-- Select --</option>' + projectsCache.filter(p => p.active).map(p => `<option value="${p.fbKey}" ${p.fbKey === c.projectKey ? 'selected' : ''}>${p.name}</option>`).join('');
    new bootstrap.Modal($('clientModal')).show();
}

function saveClient() {
    const key = $('cFbKey').value;
    const data = {
        name: $('cName').value.trim(),
        username: $('cUser').value.trim().toLowerCase(),
        projectKey: $('cProj').value,
        role: 'client',
        active: $('cActive').checked,
        updatedAt: Date.now()
    };
    
    if (!data.name || !data.username || !data.projectKey) return alert('Fill required fields');
    
    const pwd = $('cPwd').value;
    if (!key && !pwd) return alert('Password required');
    if (pwd) data.password = pwd;
    
    const dup = usersCache.find(u => u.username === data.username && u.fbKey !== key);
    if (dup) return alert('Username exists');
    
    if (key) {
        db.ref('users/' + key).update(data);
        toast('Client updated');
    } else {
        data.createdAt = Date.now();
        db.ref('users').push(data);
        toast('Client added');
    }
    bootstrap.Modal.getInstance($('clientModal')).hide();
}

function delClient(key) {
    if (confirm('Delete client?')) {
        db.ref('users/' + key).remove();
        toast('Client deleted');
    }
}

// ============== RECORDS ==============
function loadRecords() {
    let list = recordsCache;
    
    if (currentUser.role === 'staff') list = list.filter(r => r.userKey === currentUser.fbKey);
    else if (currentUser.role === 'client') list = list.filter(r => r.projectKey === currentUser.projectKey);
    
    const from = $('fFrom').value, to = $('fTo').value, type = $('fType').value;
    if (from) list = list.filter(r => r.date >= from);
    if (to) list = list.filter(r => r.date <= to);
    if (type) list = list.filter(r => r.formType === type);
    
    list.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    
    const types = [...new Set(recordsCache.map(r => r.formType))];
    $('fType').innerHTML = '<option value="">All Types</option>' + types.map(t => `<option value="${t}">${formName(t)}</option>`).join('');
    
    $('recBody').innerHTML = list.map(r => {
        const p = projectsCache.find(x => x.fbKey === r.projectKey);
        const u = usersCache.find(x => x.fbKey === r.userKey);
        return `<tr>
            <td>${fmtD(r.date)}</td>
            <td>${p?.name || '-'}</td>
            <td><span class="badge bg-primary">${formName(r.formType)}</span></td>
            <td>${u?.name || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewRec('${r.fbKey}')"><i class="fas fa-eye"></i></button>
                ${currentUser.role === 'admin' ? `<button class="btn btn-sm btn-outline-danger" onclick="delRec('${r.fbKey}')"><i class="fas fa-trash"></i></button>` : ''}
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="5" class="text-center text-muted">No records</td></tr>';
}

function viewRec(key) {
    const r = recordsCache.find(x => x.fbKey === key);
    const p = projectsCache.find(x => x.fbKey === r?.projectKey);
    const u = usersCache.find(x => x.fbKey === r?.userKey);
    if (!r) return;
    
    $('viewBody').innerHTML = genReport(r, p, u);
    new bootstrap.Modal($('viewModal')).show();
}

function delRec(key) {
    if (confirm('Delete record?')) {
        db.ref('records/' + key).remove();
        toast('Deleted');
    }
}

// ============== FORMS ==============
function openForm(type) {
    const pk = $('selProject').value;
    if (!pk) return alert('Select a project');
    
    curForm = type;
    curProj = projectsCache.find(p => p.fbKey === pk);
    
    if (type === 'attendance') {
        openAttModal();
        return;
    }
    
    $('formTitle').textContent = formName(type);
    $('formBody').innerHTML = genFormHTML(type);
    rowCount = 0;
    new bootstrap.Modal($('formModal')).show();
}

function genFormHTML(t) {
    const d = new Date().toISOString().split('T')[0];
    const tm = new Date().toTimeString().slice(0, 5);
    
    const base = `<div class="row g-2 mb-3">
        <div class="col-md-6"><label class="form-label">Date</label><input type="date" id="fDate" class="form-control" value="${d}"></div>
        <div class="col-md-6"><label class="form-label">Time</label><input type="time" id="fTime" class="form-control" value="${tm}"></div>
    </div>`;
    
    if (t === 'insecticide') {
        return base + `
            <div class="row g-2 mb-3">
                <div class="col-md-4"><label class="form-label">Chemical</label><select id="fChem" class="form-select"><option>Deltamethrin</option><option>Alphacypermethrin</option><option>Cypermethrin</option></select></div>
                <div class="col-md-4"><label class="form-label">Qty (ml)</label><input type="number" id="fQty" class="form-control" value="50"></div>
                <div class="col-md-4"><label class="form-label">Water (L)</label><input type="number" id="fWater" class="form-control" value="10"></div>
            </div>
            <h6>Areas</h6>
            <div id="insList" class="mb-2">${['Outside', 'Drain', 'Washroom', 'Office'].map(a => `<div class="d-inline-block bg-light border rounded px-2 py-1 me-2 mb-2 ins-tag"><span>${a}</span> <i class="fas fa-times text-danger ms-1" onclick="this.parentElement.remove()" style="cursor:pointer"></i></div>`).join('')}</div>
            <div class="input-group mb-3"><input type="text" id="newArea" class="form-control" placeholder="Add area"><button class="btn btn-outline-primary" onclick="addArea()">Add</button></div>
            <div class="mb-3"><label class="form-label">Remarks</label><textarea id="fRem" class="form-control" rows="2"></textarea></div>`;
    }
    
    if (t === 'checklist') {
        const items = ['Spray areas', 'Inspect EFKs', 'Inspect Glue Boxes', 'Check Bait Boxes', 'Check Chemicals', 'Inspect Snake Boxes'];
        return `<div class="row g-2 mb-3">
            <div class="col-md-4"><label class="form-label">Date</label><input type="date" id="fDate" class="form-control" value="${d}"></div>
            <div class="col-md-4"><label class="form-label">Time In</label><input type="time" id="fIn" class="form-control" value="${tm}"></div>
            <div class="col-md-4"><label class="form-label">Time Out</label><input type="time" id="fOut" class="form-control"></div>
        </div>
        <table class="table table-sm"><tbody>${items.map((it, i) => `<tr><td>${i+1}</td><td>${it}</td><td><select class="form-select form-select-sm fAct" data-item="${it}"><option value="done">Done</option><option value="pending">Pending</option><option value="na">N/A</option></select></td></tr>`).join('')}</tbody></table>
        <div class="mb-3"><label class="form-label">Remarks</label><textarea id="fRem" class="form-control" rows="2"></textarea></div>`;
    }
    
    return base + `<h6>Entries</h6>
        <table class="table table-sm table-bordered"><thead><tr><th>#</th><th>Location</th><th>Count</th><th>Status</th><th></th></tr></thead>
        <tbody id="genBody"></tbody></table>
        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addRow()"><i class="fas fa-plus"></i> Add</button>
        <div class="mb-3"><label class="form-label">Remarks</label><textarea id="fRem" class="form-control" rows="2"></textarea></div>`;
}

function addArea() {
    const v = $('newArea').value.trim();
    if (v) {
        const d = document.createElement('div');
        d.className = 'd-inline-block bg-light border rounded px-2 py-1 me-2 mb-2 ins-tag';
        d.innerHTML = `<span>${v}</span> <i class="fas fa-times text-danger ms-1" onclick="this.parentElement.remove()" style="cursor:pointer"></i>`;
        $('insList').appendChild(d);
        $('newArea').value = '';
    }
}

function addRow() {
    rowCount++;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${rowCount}</td>
        <td><input type="text" class="form-control form-control-sm gen-loc"></td>
        <td><input type="number" class="form-control form-control-sm gen-cnt" value="0"></td>
        <td><select class="form-select form-select-sm gen-st"><option value="ok">OK</option><option value="bad">Bad</option></select></td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>`;
    $('genBody').appendChild(tr);
}

function saveForm() {
    const data = {
        formType: curForm,
        projectKey: curProj.fbKey,
        userKey: currentUser.fbKey,
        date: $('fDate')?.value,
        createdAt: Date.now()
    };
    
    if (!data.date) return alert('Enter date');
    
    if (curForm === 'insecticide') {
        data.time = $('fTime').value;
        data.chemical = $('fChem').value;
        data.qty = $('fQty').value;
        data.water = $('fWater').value;
        data.areas = [...document.querySelectorAll('.ins-tag span')].map(s => s.textContent);
        data.remarks = $('fRem').value;
    } else if (curForm === 'checklist') {
        data.timeIn = $('fIn').value;
        data.timeOut = $('fOut').value;
        data.activities = [...document.querySelectorAll('.fAct')].map(s => ({ item: s.dataset.item, st: s.value }));
        data.remarks = $('fRem').value;
    } else {
        data.time = $('fTime').value;
        data.entries = [...document.querySelectorAll('#genBody tr')].map((r, i) => ({
            sr: i + 1,
            loc: r.querySelector('.gen-loc')?.value,
            cnt: parseInt(r.querySelector('.gen-cnt')?.value) || 0,
            st: r.querySelector('.gen-st')?.value
        }));
        data.remarks = $('fRem').value;
    }
    
    db.ref('records').push(data);
    bootstrap.Modal.getInstance($('formModal')).hide();
    toast('Record saved!');
}

// ============== ATTENDANCE ==============
function openAttModal() {
    const d = new Date().toISOString().split('T')[0];
    const tm = new Date().toTimeString().slice(0, 5);
    
    $('aDate').value = d;
    $('aIn').value = tm;
    $('aOut').value = '';
    $('aWork').value = '';
    $('aRem').value = '';
    $('aVerified').value = 'false';
    
    new bootstrap.Modal($('attModal')).show();
    
    if (curProj?.gpsEnabled && curProj?.lat && curProj?.lng) {
        $('gpsSection').classList.remove('hide');
        $('gpsSkipMsg').style.display = 'none';
        $('attForm').classList.add('hide');
        $('attSaveBtn').disabled = true;
        $('retryBtn').classList.add('hide');
        
        setTimeout(() => {
            if (attMap) attMap.remove();
            attMap = L.map('attMap').setView([curProj.lat, curProj.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(attMap);
            L.marker([curProj.lat, curProj.lng]).addTo(attMap).bindPopup(curProj.name);
            L.circle([curProj.lat, curProj.lng], { radius: curProj.radius || 50, color: '#004080', fillOpacity: 0.1 }).addTo(attMap);
            checkLoc();
        }, 500);
    } else {
        $('gpsSection').classList.add('hide');
        $('gpsSkipMsg').style.display = 'block';
        $('attForm').classList.remove('hide');
        $('attSaveBtn').disabled = false;
        $('aVerified').value = 'skipped';
    }
}

function checkLoc() {
    $('retryBtn').classList.add('hide');
    $('locStatus').className = 'loc-status wait';
    $('locStatus').innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i><div><strong>Getting location...</strong></div>';
    
    if (!navigator.geolocation) return locErr('Not supported');
    
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            const dist = getDist(lat, lng, curProj.lat, curProj.lng);
            const radius = curProj.radius || 50;
            
            $('aLat').value = lat;
            $('aLng').value = lng;
            $('aDist').value = Math.round(dist);
            
            L.marker([lat, lng], { icon: L.divIcon({ html: '<i class="fas fa-user" style="color:#28a745;font-size:20px"></i>', iconSize: [20, 20], className: '' }) }).addTo(attMap);
            attMap.fitBounds([[lat, lng], [curProj.lat, curProj.lng]], { padding: [30, 30] });
            
            if (dist <= radius) {
                $('locStatus').className = 'loc-status ok';
                $('locStatus').innerHTML = `<i class="fas fa-check-circle text-success"></i><div><strong>Verified!</strong><br><small>${Math.round(dist)}m from site</small></div>`;
                $('aVerified').value = 'true';
                $('attSaveBtn').disabled = false;
                $('attForm').classList.remove('hide');
            } else {
                $('locStatus').className = 'loc-status no';
                $('locStatus').innerHTML = `<i class="fas fa-times-circle text-danger"></i><div><strong>Too Far!</strong><br><small>${Math.round(dist)}m away</small></div>`;
                $('aVerified').value = 'false';
                $('retryBtn').classList.remove('hide');
            }
        },
        err => locErr(err.message),
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function locErr(msg) {
    $('locStatus').className = 'loc-status no';
    $('locStatus').innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i><div><strong>Error</strong><br><small>${msg}</small></div>`;
    $('retryBtn').classList.remove('hide');
}

function getDist(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function saveAtt() {
    const data = {
        formType: 'attendance',
        projectKey: curProj.fbKey,
        userKey: currentUser.fbKey,
        date: $('aDate').value,
        timeIn: $('aIn').value,
        timeOut: $('aOut').value,
        work: $('aWork').value,
        remarks: $('aRem').value,
        location: {
            lat: parseFloat($('aLat').value) || 0,
            lng: parseFloat($('aLng').value) || 0,
            dist: parseInt($('aDist').value) || 0,
            verified: $('aVerified').value === 'true',
            skipped: $('aVerified').value === 'skipped'
        },
        createdAt: Date.now()
    };
    
    db.ref('records').push(data);
    bootstrap.Modal.getInstance($('attModal')).hide();
    toast('Attendance saved!');
}

// ============== SETTINGS ==============
function saveProfile() {
    const name = $('setName').value.trim();
    const pass = $('setPass').value;
    
    if (!name) return alert('Name required');
    
    const updates = { name, updatedAt: Date.now() };
    if (pass) updates.password = pass;
    
    db.ref('users/' + currentUser.fbKey).update(updates);
    $('userName').textContent = name;
    toast('Profile updated');
}

async function syncNow() {
    toast('Syncing...', 'info');
    await ensureAdmin();
    toast('Sync complete!');
    refreshPage();
}

function exportData() {
    const data = { users: usersCache, projects: projectsCache, records: recordsCache, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'a2z_backup_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    toast('Exported');
}

function clearData() {
    if (confirm('DELETE ALL DATA?')) {
        if (confirm('Really sure?')) {
            db.ref().remove();
            localStorage.clear();
            location.reload();
        }
    }
}

// ============== REPORT ==============
function genReport(r, p, u) {
    let content = '';
    if (r.formType === 'attendance') {
        content = `<div class="summary-grid" style="grid-template-columns:1fr 1fr">
            <div class="summary-box"><div class="num">${r.timeIn || '-'}</div><div class="lbl">In</div></div>
            <div class="summary-box"><div class="num">${r.timeOut || '-'}</div><div class="lbl">Out</div></div>
        </div><div class="bg-light p-3 rounded mb-3"><strong>Work:</strong><br>${r.work || 'N/A'}</div>`;
    } else if (r.formType === 'insecticide') {
        content = `<div class="summary-grid">
            <div class="summary-box"><div class="num">${r.chemical}</div><div class="lbl">Chemical</div></div>
            <div class="summary-box"><div class="num">${r.qty}ml</div><div class="lbl">Qty</div></div>
            <div class="summary-box"><div class="num">${r.water}L</div><div class="lbl">Water</div></div>
            <div class="summary-box"><div class="num">${(r.areas||[]).length}</div><div class="lbl">Areas</div></div>
        </div><div class="p-3 bg-light rounded mb-3"><strong>Areas:</strong> ${(r.areas||[]).join(', ')}</div>`;
    } else if (r.formType === 'checklist') {
        content = `<ul class="list-group mb-3">${(r.activities||[]).map((a,i) => `<li class="list-group-item d-flex justify-content-between"><span>${i+1}. ${a.item}</span><span class="badge ${a.st==='done'?'bg-success':a.st==='pending'?'bg-warning':'bg-secondary'}">${a.st}</span></li>`).join('')}</ul>`;
    } else {
        content = `<table class="table table-sm table-bordered"><thead><tr><th>#</th><th>Location</th><th>Count</th><th>Status</th></tr></thead>
        <tbody>${(r.entries||[]).map(e => `<tr><td>${e.sr}</td><td>${e.loc}</td><td>${e.cnt}</td><td>${e.st}</td></tr>`).join('')}</tbody></table>`;
    }
    
    return `<div class="report">
        <div class="report-head"><div><h3>${COMPANY.name}</h3><small>IPM Services</small></div><div class="text-end"><small>${fmtD(r.date)}</small></div></div>
        <div class="report-title"><h4>${formName(r.formType)} Report</h4></div>
        <div class="report-body">
            <div class="info-grid">
                <div class="info-item"><label>Project</label><span>${p?.name||'-'}</span></div>
                <div class="info-item"><label>Client</label><span>${p?.client||'-'}</span></div>
                <div class="info-item"><label>Date</label><span>${fmtD(r.date)}</span></div>
                <div class="info-item"><label>PCO</label><span>${u?.name||'-'}</span></div>
            </div>
            ${content}
            ${r.remarks ? `<div class="bg-warning bg-opacity-25 p-3 rounded"><strong>Remarks:</strong> ${r.remarks}</div>` : ''}
        </div>
    </div>`;
}

// ============== UTILS ==============
function formName(t) {
    const n = { attendance:'Attendance', insecticide:'Insecticide Log', gluebox:'Glue Box', efk:'EFK', lizard:'Lizard', cat:'Cat', snake:'Snake', checklist:'Checklist' };
    return n[t] || t;
}

function fmtD(d) { return d ? new Date(d).toLocaleDateString('en-GB') : '-'; }
function fmtDT(ts) { return ts ? new Date(ts).toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : '-'; }

// ============== START ==============
init();
</script>
</body>
</html>
